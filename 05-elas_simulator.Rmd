

```{r, include=FALSE}
library(tidyverse)
library(pander)
library(kableExtra)
library(purrr)
library(readxl)
library(glue)

knitr::opts_chunk$set(results = 'show', echo = FALSE, fig.pos='ht',
                      fig.align = 'center',
                      message = FALSE, warning = FALSE)

source('R/R_functions.R')

FIG_FOLDER <- 'figures/ch5/'

CH5_FIG_LIST <- list(
  `FIG1` = 'fig1-flowchart_liver_allocation',
  `FIG2` = 'fig2-post_txp_event_rates',
  `FIG3` = 'fig3-results_BELIAC',
  `SFIG1` = 'sfig1-post_txp_relisting_rates',
  `SFIG5` = 'sfig5-init_rescue',
  `SFIG6` = 'sfig6'
) |>
  map(
    ~ paste(FIG_FOLDER, .x, sep = '/')
  )

CH5_FIG_CAPTIONS <- list(
  FIG1="Event handling flowchart for the ELAS simulator. Inputs and parameters are represented using parallelograms. D, deceased on the waiting list; ELAS, Eurotransplant Liver Allocation System; FES, Future Event Set; MELD, Model for End-Stage Liver Disease; R, waiting list removal.",
  FIG2="The estimated event probabilities for transplant recipients, per country for different time horizons. An event was defined as re-transplantation or waiting list death, whichever occurred first.",
  FIG3="Distribution of (N)SE MELD scores at transplantation for exception candidates (left) and laboratory MELD scores at transplantation for non-exception candidates (right) in ELAS simulations. Only transplantations that were the result of patient-driven allocation are shown. Boxplots and distributions were calculated over 50 simulations.",
  SFIG5="The relation between the number of offers made in standard allocation and the probability that non-standard allocation is initiated. The country- and blood group-specific survival curves were generated by predicting the number of offers for an average patient.",
  SFIG6="Cumulative incidence curves showing the probability of listing for repeat transplantation, stratified by time-to-event categories. These curves were estimated with the Kaplan-Meier estimator based on candidates transplanted between January 1, 2012 and December 31, 2019.",
   SFIG1="Estimated re-listing rates for transplant recipients, per country for different time horizons."
) |>
  map(format_dates) |>
  
  map(escape_latex)

TABLE_FOLDER <- 'tables/ch5/'

CH5_TABLE_LIST <- list(
  TAB1="tab1-example_match_list.tex",
  TAB2="tab2-validation_waitlist.tex",
  TAB3="tab3-validation_transplants.tex",
  TAB4="tab4-BELIAC_options.tex",
  TAB5="tab5-BELIAC_results.tex",
  TAB6="tab6-exits_by_score.tex",
  TAB7="tab7-exits_sodium_completeness.tex",
  TAB8="tab_vulnerable_bystanders.csv",
  TABCOMPRESCUE = 'tabcomprescue.xlsx',
  TAB1_PAT_SIMSTART = 'ch5_table1_patients_simstart.csv',
  TAB1_PAT_LISTED = 'ch5_table1_patients_listed.csv',
  TAB1_DONORS = 'ch5_table1_donors.csv'
) |>
  map(
    ~ paste(TABLE_FOLDER, .x, sep = '/')
  )

CH5_TABLE_CAPTIONS <- list(
  TAB1 = "Example of a match list for an adult liver graft donated by a blood group A donor in the Netherlands. Under the restricted ABO blood group rules, candidates
  with blood group A and AB are eligible for this liver. At the moment of allocation, the Netherlands has an obligation to return a blood group A liver graft to Croatia, resulting in Croatian candidates being ranked higher than all Dutch candidates in the elective tiers. This specific liver graft was declined by all Croatian and Dutch candidates and finally transplanted into a Belgian recipient.",
  TAB2 = "Validation of waiting list outcomes between January 1, 2016 and December 31, 2019. For simulations, the numbers shown are the averages and 95% interquantile ranges of outcomes over 200 simulations. The averages and ranges are displayed in bold if the simulator is not well-calibrated, i.e. the observed statistic does not fall within the 95% IQR.",
  TAB3 = "Validation of transplantations between January 1, 2016 and December 31, 2019. For simulations, the numbers shown are the averages and 95% interquantile ranges over 200 simulations. Ranges are displayed in bold if the observed statistic does not fall within the 95% IQR.",
  TAB4 = 'Policy options for the Belgian (N)SE system. Modifications are applied only to all Belgian SEs and the NSE, and not to the PED-MELD score as PED-MELD scores are valid internationally. A dash (-) indicates that the policy did not change an (N)SE attribute.',
  TAB5 = "Waiting list exits for elective candidates in Belgium between January 1, 2016, and January 1, 2020. The numbers displayed are the average number of exits over 50 simulations. Scenarios modifying the allocation rules were compared to simulations under the current ELAS rules with pairwise t-tests.",
  TAB6 = "Average number of simulated waiting list exits for candidates under UNOS-MELD and ReMELD-Na, with and without updating the S-curve. The numbers in brackets are 95% interquantile ranges, observed over 50 simulations of ELAS between January 1, 2016, and January 1. Paired t-tests were used to test whether either scenario significantly affected the simulated waiting list outcomes.",
  TAB7 = "Simulated number of waiting list deaths for candidates between January 1, 2016, and January 1, 2020, under UNOS-MELD (current) and ReMELD-Na with an updated S-curve.",
  TAB8 = "Averages of the simulated number of waiting list exits per vulnerable patient group based on simulation of ELAS between January 1, 2016 and December 31, 2019.",
TABCOMPRESCUE = "Priority of candidates in cases where a liver was initially accepted but later declined, and then re-allocated to a different recipient through competitive rescue liver allocation between January 1, 2016, and December 31, 2019. The table shows the number of candidates in each priority score category. For MELD scores, separate counts are included for the match-MELD score and lab-MELD score.",
  TAB1_PAT_SIMSTART = 'Characteristics of patients already present on the waiting list on January 1, 2016.',
  TAB1_PAT_LISTED = 'Characteristics of patients activated on the waiting list in the simulation period.',
  TAB1_DONORS = 'Characteristics of the donors reported in the simulation window whose livers were transplanted through ELAS.'
) |>
  map(format_dates) |>
  map(escape_latex) 
```


# The ELAS simulator {#CHelassimulator}

`\chaptermark{The ELAS simulator}`{=latex}

`r if (knitr::is_latex_output()) '\\vfill'`

---

`\noindent`{=latex}
An article based on this chapter has appeared in _Operations Research, Data Analytics and Logistics_, de Ferrante, H.C., de Rosner-van Rosmalen M., Smeulders, B.M.L., Spieksma, F.C.R, Vogelaar, S., 2025, [10.1016/j.ordal.2025.200476](https://doi.org/10.1016/j.ordal.2025.200476) [@deFerranteELASSimulator2025]

`\newpage`{=latex}
`\normalsize`{=latex}

`<p><strong>Abstract</strong></p>`{=html}
`\subsubsection*{Abstract}`{=latex}
  In this chapter, we present the ELAS simulator. This discrete-event simulator
  was built for the Eurotransplant Liver Allocation System (ELAS), which
  is used by Eurotransplant to allocate the livers of deceased organ donors. 
  The simulator closely mimics ELAS and has been made publicly available
  to (i) provide transparency regarding the models Eurotransplant uses to
  evaluate liver allocation policies, and (ii) facilitate collaborations with
  policymakers, scientists, and other stakeholders in evaluating
  policy changes to ELAS. In this chapter, we describe the design and the modules
  of the ELAS simulator. One of the included modules is the
  obligation module, which is instrumental in ensuring that
  international cooperation in liver allocation benefits all member
  countries of Eurotransplant.

  By default, the ELAS simulator simulates liver allocation according to
  the actual Eurotransplant allocation rules. Stochastic processes, such
  as graft offer acceptance behavior and listing for a repeat
  transplantation, are approximated with statistical models that were
  calibrated on data retrieved from the Eurotransplant database. We validate
  the ELAS simulator by comparing simulated waiting list outcomes to
  historically observed waiting list outcomes between January 1, 2016, and 
  December 31, 2019.

  The ELAS simulator has a modular design, which gives end users maximal
  control over the rules and assumptions under which Eurotransplant
  liver allocation is simulated. This makes the simulator useful for
  policy evaluation, as we illustrate with two clinically motivated
  case studies. For these case studies, we collaborated with hepatologists and
  transplantation surgeons from two liver advisory committees affiliated
  with Eurotransplant.

`\newpage`{=latex}
`\normalsize`{=latex}

## Introduction

The Eurotransplant Liver and Intestine Advisory Committee (ELIAC) plays a key
role in developing liver allocation policies in Eurotransplant; ELIAC
monitors the Eurotransplant liver allocation system (ELAS) and makes proposals
to the Eurotransplant Board on how to improve liver allocation rules
according to the latest medical insights. Since the introduction of MELD-based liver
allocation in December 2006, ELIAC has brought forward several issues with ELAS; for 
example, it has been reported that ELAS overprioritizes candidates who receive
exception points [@umgelterDisparitiesEurotransplantLiver2017a], and that MELD 
disadvantages candidates with small body sizes
[@Sneiders2023].
Despite the identification of such issues, the current liver allocation
system has changed little since the initiation of MELD-based liver
allocation in Eurotransplant.

An important reason for the lack of policy change in ELAS is that Eurotransplant
has lacked tools that can help map the impact of allocation policy changes on liver
waiting list outcomes. There is a long history of using operations research and 
discrete-event simulation for this purpose, with early work including the development of the UNOS
Liver Allocation Model (ULAM) for U.S. liver allocation [@Pritsker1995].

In the United States, this work has culminated in the Simulation Allocation Models (SAMs)
[@ThompsonXSAM2004], which is a family of discrete-event simulators
maintained by the Scientific Registry of Transplant Recipients (SRTR). 
LSAM -- SRTR's tool for liver allocation [@ThompsonXSAM2004] --
is used routinely by the scientific community and
policymakers to study alternative liver allocation rules. For example,
LSAM has been used to study the impact of expanding MELD with extra
biomarkers [@kimHyponatremiaMortalityPatients2008a; @kimMELD3point0],
the impact of alternative geographic sharing rules
[@freemanImprovingLiverAllocation2004; @axelrodEconomicImplicationsBroader2011; @gentryAddressingGeographicDisparities2013; @goelLiverSimulatedAllocation2018; @akshatHeterogeneousDonorCircles2024],
and the impact of policy changes that improve access to transplantation for
specific patient groups such as pediatric and female patients
[@peritoImpactIncreasedAllocation2019; @heimbachDelayedHepatocellularCarcinoma2015;
@bernardsAwardingAdditionalMELD2022]. Other organ allocation organizations also 
routinely note the use of simulators for evaluation of new liver allocation 
policies, for example in France [@bayer2021removing] and the United
Kingdom [@Allen2024].

Simulation can thus play a key role in moving Eurotransplant's liver
allocation system forward. This was recognized by Eurotransplant in the late
1990s, when computer simulations motivated a switch from ABO blood 
group-identical liver allocation to the restricted ABO-compatible matching policies
that are still in use today [@demeesterWhichABOmatchingRule2002]. However, a simulation
model developed specifically for Eurotransplant has not been available. 

Existing simulation models are also not applicable to Eurotransplant. Such models 
typically simulate allocation for a single patient population, while Eurotransplant needs
to balance the interests of the populations from its eight member
countries. Moreover, existing models typically implement allocation
rules that are specific to the country for which the simulator was
designed. For example, allocation rules in LSAM emphasize the physical distance between the donor and transplantation
candidate, as geographical sharing in the United States is
primarily constrained by these physical distances. Conversely, in Eurotransplant,
geographical sharing is mostly impeded by country borders.
ELAS therefore gives priority to candidates who are located in the
same country as the donor, and implements a mechanism that
ensures that livers transplanted with priority across country borders are repaid 
to the exporting country. These mechanisms have not been implemented for
existing simulation models, making these models a poor fit for Eurotransplant.

This has motivated us to develop a discrete-event simulator that is tailored to
ELAS. We refer to this simulator as the *ELAS simulator*. Code for the
ELAS simulator is implemented in Python and made publicly available
together with synthetic data.^[[http://github.com/hansdeferrante/Eurotransplant_ELAS_simulator](http://github.com/hansdeferrante/Eurotransplant_ELAS_simulator)] By default, the ELAS simulator
simulates liver allocation according to Eurotransplant allocation rules.
The modular design of the simulator enables end users to use the
simulator for policy evaluation.

It is clear that the development of the ELAS simulation could not be
done, and was not done, in isolation. Multiple stakeholders were involved
in various phases of the project. In particular, members of the
Eurotransplant Liver and Intestine Advisory Committee (ELIAC), who are hepatologists and transplant surgeons who represent
Eurotransplant's member countries, have given feedback on numerous
occasions on the conceptual design of the simulator; also, at
Eurotransplant Annual Meetings, physicians and transplantation
coordinators have commented on various aspects of the simulator.

This chapter is structured as follows. In Section \@ref(sec:elassystem), we give a
description of Eurotransplant's liver allocation system (ELAS). In
Section \@ref(sec:elasdesign) we
discuss the design of the ELAS simulator, and give an overview of the
general flow of the simulations. In Section
\@ref(sec:elasmodules), we
describe important modules of the ELAS simulator, each of which emulates
a key aspect of the liver allocation process. In Section
\@ref(sec:elasvv),
we discuss verification and validation of the ELAS simulator. In Section
\@ref(sec:elascasestudies), we illustrate with two clinically
motivated case studies that the ELAS simulator is useful for policy
evaluation. We conclude and discuss in Section
\@ref(sec:elasconclusion).

## The Eurotransplant Liver Allocation System (ELAS) {#sec:elassystem}

We provide a simplified description of ELAS below. Comprehensive descriptions of ELAS
are available elsewhere
(see [@jochmansAdultLiverAllocation2017; @ETLiverMan2025]). Fundamental to
ELAS is the laboratory MELD (lab-MELD) score, which quantifies a
candidate's 90-day waiting list mortality risk based on serum bilirubin, 
serum creatinine, and the INR
[@kamathModelPredictSurvival2001]. However, candidate prioritization is not solely based on
lab-MELD scores, because certain patient groups would be underserved by
such an allocation. 
`\newpage`{=latex}
Specifically, ELAS also prioritizes candidates with:

-   the High Urgency (HU) status, 

-   the Approved Combined Organ (ACO) status that is given to
    candidates who require a combined transplantation of a liver with a
    heart, lung, pancreas, or intestine,

-   pediatric MELD (PED-MELD) scores that are assigned automatically to candidates 
    of pediatric age,^[younger than 18 in all countries since March 2025.] and

-   Standard and Non-Standard exception (SE / NSE) MELD scores that can be awarded
    to patients who require access to liver transplantation for other reasons than a high
    short-term mortality risk.

When a liver becomes available for allocation, Eurotransplant runs the liver
*match algorithm* against a central database in which candidates for liver
transplantation are registered. This computer algorithm implements the 
prioritization mechanisms of ELAS. Based on all the waiting candidates, this
algorithm returns a list of candidates eligible to receive the liver graft.
This match list is ordered based on donor and
candidate characteristics, and the order determines the sequence in
which candidates are offered the liver graft by Eurotransplant. An
actual Eurotransplant liver match list for an adult blood group A donor
reported from the Netherlands is shown in Table \@ref(tab:ch5tab1).

At the highest level, the Eurotransplant match list order is based on
*match tiers*. Candidates in higher tiers have priority over
candidates in lower tiers. The first ELAS tier consists of candidates
with the High Urgency (HU) status. The second tier consists of
candidates with the Approved Combined Organ (ACO) status. Candidates
with HU or ACO status are given international priority in
Eurotransplant. A payback mechanism is used for grafts accepted internationally
in HU and ACO tiers. Specifically, international HU / ACO transplantations create an
*obligation* for the receiving country to offer the next available liver
within the same blood group to the donor country until the obligation is
settled (see Section \@ref(sec:elasobligations) for more information).
Candidates without an HU or ACO status are referred to as *elective* candidates
in Eurotransplant. These elective candidates are ranked in the remaining tiers.

Whether candidates appear on the match list and the rank at which they appear
is jointly determined by patient *eligibility* criteria (blood
groups), *ranking* criteria (MELD, pediatric status, donor/recipient blood
group combination), and *filtering* criteria (patients can indicate that they
do not want to be considered for certain donors with allocation
profiles). These patient eligibility criteria, ranking criteria, and
filtering criteria are multi-factorial and differ between the member countries of Eurotransplant.
`\newpage`{=latex}
```{r ch5tab1, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB1'), fig.pos='ht'}
if (knitr::is_html_output()) {
  readLines(chuck(CH5_TABLE_LIST, 'TAB1')) |>
    purrr::keep(function(.x) str_detect(.x, '&')) |>
    tail(-1) |>
    str_remove_all('\\t') |>
    str_remove_all('\\\\') |>
    str_remove_all('$') |>
    str_remove_all(fixed('hspace{1em}')) |>
    paste0(collapse = '\n') |>
    read_delim('&', col_names = c('tier', 'offered to', 'candidate country', 'rank', 'match-MELD', 'lab-MELD', 'PED-MELD', '(N)SE-MELD', 'candidate blood group', 'accepted?')) |>
    select(-`PED-MELD`) |>
    mutate(tier = rev(zoo::na.locf(rev(tier)))) |>
    mutate_all(trimws) |>
    mutate_all(str_remove_all, fixed('raggedrightarraybackslash ')) |>
    mutate_all(
      function(.x) if_else(
        str_detect(.x, '\\{'), str_extract(.x, '(?<=\\{)[a-z].+(?=\\})'), .x
      )
    ) |>
    mutate_all(
      str_replace, fixed('center('), 'center<br>('
    ) |>
    mutate(
      across(
        c(`offered to`, `candidate country`),
        function(.x) if_else(nchar(.x) == 0, NA_character_, .x)
      ),
      across(
        c(`offered to`, `candidate country`),
        function(.x) rev(zoo::na.locf(rev(.x)))
      )
    ) |>
    kable(format='html', escape=FALSE, align='ccccccccc') |>
    kable_styling(font_size=14) |>
    collapse_rows(c(1,2,3))
} else if (knitr::is_latex_output()) {
  wrap_table(
    chuck(CH5_TABLE_LIST, 'TAB1'),
    my_label = 'tab:ch5tab1',
    my_caption = chuck(CH5_TABLE_CAPTIONS, 'TAB1'),
    scale_down = TRUE
  )
}
```

`\FloatBarrier`{=latex}
`\newpage`{=latex}

A rule common to all countries is that elective candidates listed in the same country
as the donor have priority over elective candidates listed in other countries. Other
factors that affect the ranking of candidates include the combination of the donor and 
candidate blood groups, whether the donor and/or candidate are pediatric,
whether the adult is low-weight (<55 kg), as well as where the candidate is located
geographically relative to the donor (same center, same region, same country, or
different countries). The order of the match list in elective tiers is also affected by the existence of obligations.
For example, when the match list shown in Table \@ref(tab:ch5tab1) was created, the Netherlands had an
obligation to offer a blood group A liver to Croatia. Consequently,
in the elective tier all Croatian candidates were ranked above the Dutch
candidates. The most important factor for ranking candidates in elective
tiers is the *match*-MELD score (see Table
\@ref(tab:ch5tab1)). This match-MELD score is the maximum of a candidate's lab-MELD
score and any received exception points (PED-MELD, SE-MELD, or NSE-MELD). We point
out that exceptional scores (SE-MELDs or NSE-MELDs) are valid only 
for national allocation or when an offer is based on an obligation to pay back a liver.

Most offers in ELAS are *recipient-driven*, which means that
Eurotransplant offers the liver graft to a named candidate
[@jochmansAdultLiverAllocation2017]. Under specific circumstances,
Eurotransplant makes a *center offer* to candidates, which means that centers
are allowed to select any blood group compatible candidate from their waiting
list for transplantation. Offers to Croatia based on an obligation are an example of
center offers, which explains why a single offer to 29 Croatian patients appears
on the match list in Table \@ref(tab:ch5tab1). The position of center offers
on the match list is determined by the highest rank that is achieved by any
candidate listed in the center in elective tiers. We note that national regulations differ on
when offers are center-driven. These rules are described in the Eurotransplant
liver manual (see [@ETLiverMan2025]).

The order of the match list determines the sequence in which Eurotransplant contacts
centers in *standard allocation*. In cases where the loss of a transplantable graft
is anticipated, Eurotransplant can deviate from this allocation order (see
[@jochmansAdultLiverAllocation2017; @ETLiverMan2025]). For example, Eurotransplant
is allowed to start an *extended allocation* procedure 2 hours before the planned
explantation procedure (1 hour in Germany). Centers in the vicinity of the donor
center are then contacted, and are given 30 minutes to propose up to two
candidates for transplantation. The proposed candidate with the highest rank 
on the match list is then selected for transplantation. If extended allocation is unsuccessful, Eurotransplant can also offer 
the graft to centers located further away from the donor center on a first-come, first-served basis
with *competitive rescue allocation*. In
total, 20% to 25% of liver grafts are transplanted through *non-standard* allocation
mechanisms [@jochmansAdultLiverAllocation2017]. Extended allocation accounts for the majority of these placements.
`\vfill`{=latex}
`\newpage`{=latex}

## The design of the ELAS simulator {#sec:elasdesign}

The ELAS simulator was designed to enable end users to assess the impact of changes
to the liver allocation rules on waiting list mortality rates and access to
transplantation. We follow existing literature
by using discrete-event simulation (DES) for this purpose [@shechterClinicallyBasedDiscreteEvent2005; @Pritsker1995; @ratcliffeSimulationModellingApproach2001; @ThompsonXSAM2004]. With DES,
complex processes are analyzed by determining how system states are
affected by a sequence of discrete events. Within the ELAS simulator,
the system states are (i) the statuses of transplant candidates
(whether they remain alive, their last known MELD score, their accrued
waiting time, and other information used in allocation), and (ii)
obligations to return a graft. The discrete events which affect these
system states are (i) patient events, which directly modify the
candidate's state (e.g. updates to the MELD score), and (ii) liver donation 
events, which generally lead to the transplantation
of a candidate, and which may result in the creation or redemption of an
obligation to pay back a liver graft.

Which candidate is transplanted when a donor becomes available is affected by several stochastic processes.
One such process is the graft offer acceptance behavior of the transplant centers.
Such behavior plays a
key role in liver allocation because the transplant centers frequently
decline liver grafts they deem unsuitable for their candidates.^[In fact, only 20% of transplanted livers are accepted
by the top-ranked candidate in Eurotransplant.] Another stochastic 
process is that recipients of a
liver transplant can experience a early graft failure, and may be listed for a
repeat transplantation. To accurately simulate outcomes of the
Eurotransplant liver allocation process, the ELAS simulator also has to
mimic these stochastic processes.

For discussion of the design of the ELAS simulator, we find it helpful
to distinguish between

1.  the *organ allocation environment*, with which we refer to the
    overall setting in which allocation policies operate. This
    environment is deterministically defined by the simulation settings
    and input streams. Of key importance are the simulation input streams, which
    are the datasets that define the donors which become available for
    transplantation, the candidates who appear on the liver waiting
    list, and the donor and patient events that drive ELAS simulations.
    These input streams also specify the nested structure of agents in
    the ELAS simulations: donors and patients are nested in hospitals and 
    transplant centers, which are in turn nested in the
    Eurotransplant member countries. The organ allocation environment has
    to be specified in advance of any simulation. We discuss the
    requirements for input streams in Section 
    \@ref(sec:elasenvironment). How simulations are
    initialized based on input streams is discussed in Section
    \@ref(sec:elasinit). How simulations proceed is
    illustrated in Section
    \@ref(sec:elasoverview), and

2.  *simulation modules*, which are implemented in Python code. These
    modules emulate key aspects of the liver allocation procedure. These
    processes include the generation of liver match lists according to
    ELAS' liver allocation rules, the simulation of graft offer acceptance
    behavior, ELAS' obligation system, and ELAS' exception point system.
    We discuss the implemented modules in Section
    \@ref(sec:elasmodules).

With this overall design, the ELAS simulator is similar to LSAM, the simulator that
has been used extensively to study organ allocation in the United
States. We also point out several differences. Most importantly, the
ELAS simulator is developed specifically for Eurotransplant, and takes
into account the multi-national setting; we include international
sharing rules and allow for allocation rules to differ per country.
Other major differences include that (i) centers can decline
liver offers for all their candidates in ELAS simulations, (ii) the ELAS simulator can
approximate outcomes of non-standard allocation while LSAM always places
livers through standard allocation, (iii) organ offer acceptance models specific
to pediatric candidates are included, (iv) the splitting of liver grafts is
simulated, and (v) simulation of re-listing for repeat transplantation is
based on historical re-listing data.

### The organ allocation environment {#sec:elasenvironment}

To simulate liver allocation with the ELAS simulator, users must provide input
streams. These input streams consist of donor and patient information, which is
used by the ELAS simulator to construct the discrete events that drive the simulator.
Users of the ELAS simulator are free to base these input streams on actual
registry data, reordered registry data, synthetic data, or combinations
thereof. Ideally, the choice on which input stream is used is based on the end user's research question of interest. For example, end users
interested in evaluating the impact of small changes to allocation rules
may use historical data from the Eurotransplant registry for simulation,
while end users interested in evaluating the effect of an expansion to
the donor pool may need to extend the historical donor pool with synthetic
donor data.

The input stream for donors must specify all the administrative and medical information
that is required for liver allocation, for predicting the acceptance of liver offers,
or for predicting post-transplant survival. Such information includes the
donor reporting date, the donor hospital and donor reporting center, the donor weight
and height, the donor blood group, and the donor death cause. In the ELAS simulator,
this information is static and represents the state of the donor on the day they
were reported to Eurotransplant.

`\newpage`{=latex}

Basic administrative and medical information necessary for allocation is also
required for the input streams for transplant candidates. Such information includes the candidate's center of listing,
the candidate's disease group, the candidate's age and weight, and the
candidate's blood group. To identify candidates listing for a repeat
transplantation, a candidate identifier must be specified. Next to
this static candidate information, dynamic information is required on
the evolution of candidate's medical condition while they await liver
transplantation. For this, the ELAS simulator requires an input stream
of candidate status updates. These status updates specify when and how a
candidate's state changes while they wait on the Eurotransplant waiting
list. Examples of such status updates are new biomarker measurements, the
reception of exception scores or upgrades thereof (NSE / SE / PED-MELD), 
changes to the candidate's waiting list status (HU / ACO / NT status), and an
exit status for each candidate (waiting list removals or waiting list
deaths). Because candidates regularly modify their *allocation
profiles*, profiles were also implemented as status updates. With these
allocation profiles, centers can indicate that a candidate does not want
to receive offers from certain liver donors. For example, many
candidates specify that they do not want to be offered grafts from
donors above a certain age threshold.

Discrete-event simulators for organ allocation require
complete knowledge on what would happen to a candidate if they would
remain on the waiting list until waiting list death or waiting list
removal. For candidates transplanted in reality, such information is
necessarily partly counterfactual; after all, transplantation prevents
us from observing what would have happened to the transplanted candidate
if they had remained on the waiting list. For other simulators, this
*counterfactual status problem* was tackled by complementing the real
statuses of a transplanted candidate with statuses copied over from a
similar but not-yet-transplanted candidate
[@shechterClinicallyBasedDiscreteEvent2005; @ThompsonXSAM2004]. We propose a
procedure that completes the status updates of transplanted candidates in this
way, and describe this procedure in detail in Appendix \@ref(APPimputation).

To summarize it briefly, the procedure first constructs a
*risk set* for each transplanted 
candidate. This is a set of candidates who
(i) remain on the waiting list, (ii) are similar to the candidate on a set of pre-specified characteristics, and (iii) face similar 90-day mortality risks 
in the absence of transplantation. A complete status update trajectory can then be
constructed by (i) randomly sampling a candidate from the risk set, and
(ii) copying over the future status updates from the sampled candidate.
By running this procedure repeatedly, we construct for each candidate
multiple potential status update trajectories. This allows us to also
quantify the uncertainty in this status update completion
procedure in simulations.

`\vfill`{=latex}

### Initialization of the ELAS simulator's system state {#sec:elasinit}

End users of the ELAS simulator must specify a simulation start and end
date, which jointly define the simulation time window. When the simulation
starts, the system state is initialized by loading from the input streams
all the donors who were reported during the simulation window, and all the 
candidates who had an active waiting list status during the simulation window. For the
loaded candidates, all status updates are pre-processed until the
simulation start date. This ensures that the states of candidates at simulation start coincide with their actual status on the simulation start date, as
specified in candidate input streams.

A potential problem is formed by candidates who (i) have in reality received a
transplantation after the simulation start date and (ii) were listed for 
repeat liver transplantation before the simulation end date, as these candidates
could simultaneously await a primary and repeat transplantation in simulation runs. 
To prevent this, the ELAS simulator by default ignores re-listings
of such candidates from the candidate input stream. Instead, patient re-listing 
is simulated by the post-transplant module. This module simulates the post-transplant survival,
and the potential re-listing of transplant recipients based on
candidate and donor characteristics (see Section \@ref(sec:elasposttransplant)).

The initialization of the discrete-event simulation is finalized by
scheduling for each donor and transplant candidate a single event
in the Future Event Set (FES). For donors, events are scheduled at the
donor reporting date that is specified in the donor input stream. For each
candidate, a single patient event is scheduled at the time of the
candidate's first available status update after the simulation start
date. Subsequent updates are scheduled in the FES only after the
existing patient event has been handled.^[This is necessitated by the
fact that processing of a status update may result in automatic scheduling
of a new update, see Section \@ref(sec:elasexceptions).]

### Overview of the simulation {#sec:elasoverview}

```{r ch5fig1, fig.cap = chuck(CH5_FIG_CAPTIONS, 'FIG1'), out.width = "90%", fig.pos="h"}
FIG <- pluck(CH5_FIG_LIST, 1)

NEEDED_FIGS <- glue('{FIG}{c(".pdf", ".svg")}')

if (any(!file.exists(NEEDED_FIGS))) {
  TEX_FIG <- paste0(FIG, '.tex')
  if (!file.exists(TEX_FIG)) {
    stop('Tex file is expected to exist')
  } else {
    process_tikz_fig(tex_fig = TEX_FIG, final_fig = FIG)
  }
  if (!file.exists(NEEDED_FIGS[[2]])) {
    stop(glue('Convert {NEEDED_FIGS[[1]]} to png'))
  }
}

if (knitr::is_html_output()) {
  knitr::include_graphics(NEEDED_FIGS[[2]])
} else if (knitr::is_latex_output()) {
  knitr::include_graphics(NEEDED_FIGS[[1]])
}
```

Figure \@ref(fig:ch5fig1) shows how patient and donor events from the
FES are processed in the ELAS simulator. In case of a patient event, the
corresponding candidate's status is updated according to their earliest
scheduled status update. In case a donor event is processed, a match list
is created. To appear
on this match list, candidates must have an active waiting list status
(T, HU, or ACO) and they must be compatible with the donor according to ELAS
blood group rules. The entities that appear on these match lists are offers
to patients and center offers (if applicable). These offers are ordered deterministically based on the allocation rules specified in the organ allocation
environment. By default, the actual ELAS allocation rules are followed,
which are summarized in Section \@ref(sec:elasmatchlist).

The ordered match list serves as an input to the graft offering module
(see Section \@ref(sec:elasacceptance)). This module mimics the graft
offering process in Eurotransplant and returns the candidate who
accepts the liver offer, if any. We point out that it is not clear
based on the match list alone which candidate is transplanted with the liver.
One reason for this is that offers are regularly declined
by the transplant centers: in fact, over half of the transplanted liver
grafts in Eurotransplant were declined by 10 or more candidates before being accepted for transplantation. A second reason is that Eurotransplant can deviate
from the standard allocation procedure to prevent the loss of
transplantable organs (see Section \@ref(sec:elassystem)). In simulating whether
a candidate accepts the offer, the module can simulate both standard and non-standard
allocation.

The ELAS simulator assumes that the candidate who accepts the liver
graft is transplanted, and removes any scheduled events for this
transplanted candidate from the Future Event Set. If a liver was allocated
across country borders in HU or ACO tiers, the obligation system module creates 
an obligation for the importing country to return a liver graft in the future 
(or settles an obligation for the exporting country, in case an existing obligation
exists). For livers exported based
on an obligation, obligations are also settled. The post-transplant module simulates
a time-until-liver-failure for each transplantation (see Section
\@ref(sec:elasposttransplant)). In case the transplant recipient
is simulated to be listed for a repeat liver transplantation before
the candidate's simulated death date, the post-transplant module schedules a "synthetic"
re-listing for the candidate (see Section \@ref(sec:elassynthreg)).

The processing of patient and donor events continues until the
simulation end date is reached. At the end of the simulation, information
on transplantations is written to an output file. A list of discarded
grafts is also written to output files, as are the final states
of all candidates present in the simulation. These final states include
candidate exit statuses (waiting, waiting list death, transplanted, or
waiting list removal), as well as their last reported MELD scores. Such
information may be summarized to calculate the
statistics relevant for a specific research question. We chose to
write raw information to files rather than predefined summaries of
information to give end users maximum flexibility in reporting more
complicated statistics.

## Modules of the ELAS simulator {#sec:elasmodules}

This section describes the key modules of the ELAS simulator: the match list
module (Section \@ref(sec:elasmatchlist)), the obligation system module (Section
\@ref(sec:elasobligations)), the exception module (Section \@ref(sec:elasexceptions)),
the graft offering module (Section \@ref(sec:elasacceptance)), and the post-transplant module
(Section \@ref(sec:elasposttxp)).

`\FloatBarrier`{=latex}

### The match list module {#sec:elasmatchlist}

When a liver graft is to be allocated, the match list
module creates an ordered list of candidates who sequentially receive
offers until a candidate accepts the liver
graft. To appear on these match lists, candidates must (i) have an active
waiting list status (transplantable, HU, or ACO), and (ii) have a blood
group compatible with that of the donor, according to ELAS
allocation rules. By default, the match list module collapses offers to
candidates who are eligible for center offers into a single center offer object.
The rank of this center offer is set equal to the rank of the top-ranked candidate
eligible for that center offer. The match lists returned by the match list module
are thereby ordered lists of center-driven and patient-driven offers,
coinciding with the structure of match lists Eurotransplant actually uses
for allocation (see the example match list in Table \@ref(tab:ch5tab1)).

The precise ordering returned by the match list module is based on the liver
allocation rules that must be pre-specified as part of organ
allocation environment. The rules made available with the ELAS simulator
are the ELAS allocation rules used between 2016 and 2024. end users of the
ELAS simulator can modify these allocation rules to study waiting list outcomes under
alternative allocation policies. Technically, the ranking of ELAS match objects (patient- or
center offers) is based on *match codes*. These match codes
consist of several components. The values of these components are determined 
by Eurotransplant allocation rules, donor and patient characteristics, 
and the existence of obligations. Currently, these match codes consist of:

1.  **match tiers**, which are used to give international
    priority to patients with HU status or ACO status,
2.  **match layers**, which differ per country and are used to give
    priority to certain patient groups (for example, to pediatric
    candidates, to blood group-identical candidates, to local
    candidates, or to candidates located in other countries based on
    obligations),
3.  **match obligation ranks**, which are used as a tiebreaker in case
    the donor country has obligations to return livers to multiple
    countries,
4.  **match-MELDs**, which are used to rank candidates in the elective
    tiers,
5.  **match locality**, which is used to prioritize patients regionally
    in Germany in elective tiers,
6.  **waiting time**, which is the number of days with a HU or ACO status
    in the HU and ACO tiers. In elective tiers, waiting time is defined as the
    number of days a candidate has had a match-MELD score at least as high
    as the current match-MELD score,
7.  **the patient listing date**, which is used as a tiebreaker.

The order of the match list is based on the lexicographical ordering of these
components.

### The obligation system module {#sec:elasobligations}

An important feature of Eurotransplant's obligation system is that
obligations within the same blood group are automatically *linked*. For
example, if Croatia has an obligation to return a blood group A
liver to Belgium, and an obligation is created for Belgium to return a
blood group A liver to Germany, the two existing obligations are
replaced by a *linked* obligation for Croatia to return a blood
group A liver to Germany.

The obligation module implemented for the ELAS simulator creates obligations
for grafts that are procured internationally in HU or ACO tiers, and automatically
replaces linkable obligations by a linked obligation. The module can also return 
for a given blood group the outstanding obligations per country,
as well as the number of days these
obligations have existed. This information is required by the ELAS
simulator's match list module to determine match obligation ranks.

### The exception score module {#sec:elasexceptions}

Patient groups who are considered to be underserved by a purely
lab-MELD-based allocation can apply for standard (SE) or non-standard
(NSE) exceptions in ELAS. Candidates who receive such (N)SE and
PED-MELD scores are awarded predefined 90-day mortality equivalents,
which are specified in percentages. The exceptions, their eligibility criteria,
and their 90-day mortality equivalents vary by member country. For example, 
in the Netherlands candidates with hepatocellular carcinoma are awarded a 10%
mortality equivalent, while a 15% mortality equivalent is awarded in Belgium. 
Pediatric patients in Eurotransplant automatically receive PED-MELD scores based
on their age, which are also based on 90-day mortality equivalents.

For allocation, these mortality equivalents are translated to the MELD scale. 
For example, a
10% and 15% mortality equivalent correspond to MELD scores of 20 and 22,
respectively [@ETLiverMan2025]. The awarded 90-day mortality equivalent
increases every 90 days^[(N)SEs that require manual re-certification increase immediately after re-certification, which can occur 14 days before expiry (i.e., every 76–90 days). Simulations assume that these (N)SEs upgrade every 80 days in case no re-certification is known for the candidate. (N)SEs and PED-MELD with automatic re-certification increase every 90 days.] for most (N)SEs and PED-MELDs, according to
exception- and country-specific increments. Some exceptions are implemented 
as "bonus SEs". These bonus SEs add a fixed percentage mortality equivalent to the
lab-MELD's 90-day mortality equivalent.^[For example, a candidate with biliary
sepsis in Germany with a MELD score of 21 would receive a 30 percent point
bonus amount. Their lab-MELD score of 21 corresponds to a 90-day mortality 
equivalent of 26%, giving them in total a 26% + 30% = 56% mortality equivalent,
which corresponds to a MELD score of 30.]

The exception score module implements this system, and is initialized
based on an external file. This file has to specify which exceptions
exist, and relevant exception attributes (the initial mortality
equivalent awarded, the 90-day increment, the maximal equivalent
awarded, the maximum age after which the exception no longer increases,
and whether the SE is a regular SE or a bonus SE). For the default organ
allocation environment, all (N)SEs and PED-MELDs existing in 2023 were
implemented. end users may modify the attributes of these exceptions to 
simulate Eurotransplant liver allocation under alternative (N)SE / PED-MELD rules. Simulation settings
also have to include parameters for the formula used to translate 90-day
mortality equivalents to the MELD scale.^[This transformation is based on a Cox 
proportional hazards model which uses MELD as the only predictor, 
and which uses a MELD score of 10 as the reference group. The curve used by Eurotransplant is given by: $$S_{90} = 0.98037 ^ {\exp\Big(0.17557(\texttt{UNOS-MELD} - 10)\Big)},$$ where 0.98037 is the 90-day mortality equivalent for a MELD score of 10, and 0.17557 is the slope on MELD.]

By default, the ELAS simulator assumes that the candidate status input
stream also specifies when exceptions are upgraded or expire. In case no
future exception status is present in the candidate status queue for an
NSE / SE / PED-MELD, the ELAS simulator assumes that the candidate would
continue to re-certify their exception according to the
exception-specific re-certification schedule. This choice is motivated
by the fact that almost all candidates with exceptions re-certify them.

### The graft offering module {#sec:elasacceptance}

For a match list, the graft offering module returns the candidate who accepts the graft offer (if any), or indicates that all eligible candidates have rejected the offer. If the graft has been turned down for all eligible candidates, the simulator can either (a) force placement of the graft in
the candidate who was most likely to accept the graft offer, or (b)
record a discard. 

The graft offering process is mimicked by (i) offering liver grafts to 
patients/centers in order of their ranking on the match list, and (ii) 
modeling organ offer acceptance as a Bernoulli process, with 
acceptance probabilities predicted based on logistic models that using
donor and patient characteristics (as in the SAM software, see [@SRTR2019]). 
The graft offering module also includes a logistic model to predict whether a
liver graft is split by the transplant center after acceptance.
Such split procedures allow centers to transplant two
candidates with one liver, and are typically performed to transplant one
pediatric and one adult patient.

There are several reasons why a candidate may not be offered a liver in
ELAS allocation despite being ranked high enough for an offer. These
reasons include that:

1.  Centers frequently decline the graft for all candidates who appear
    on the match list, even when making patient-driven offers (for
    example because of poor donor quality or capacity constraints). If centers decline for the entire center, the center will not be contacted again with an offer for the transplantation of a specific patient.

2.  Offers are not made to candidates whose allocation profiles exclude
them from being offered the liver graft (for
    example because the donor is too old).

3.  Center offers are not directly offered by Eurotransplant to individual candidates.
    Instead, the transplant center chooses a candidate for transplantation.

4.  Eurotransplant can deviate from the standard allocation procedure in
    case allocation time is limited. Offers
    to candidates not located in the vicinity of the graft are then
    bypassed.

These reasons motivated us to

1.  Implement a two-stage patient-driven offer acceptance procedure. In
    the first stage, a center-level logistic model is used to predict
    based on donor characteristics alone whether the center is willing
    to accept the graft. Provided that the center is willing to accept
    the graft, a patient-level logistic model is used to predict graft
    offer acceptance based on patient and donor characteristics.

2.  Skip offers to elective candidates whose allocation profiles indicate that they do not want to receive the liver graft.

3.  Estimate logistic regressions separately for center- and
    patient-driven offers.

4.  Approximate deviation from standard allocation (see \@ref(sec:nonstandardalloc)).

In the ELAS simulator, separate logistic models are used for four candidate groups: 
(i) pediatric candidates
with HU / ACO statuses, (ii) elective pediatric patients, (iii) adult
candidates with HU / ACO statuses, and (iv) elective adult candidates.
This stratification is motivated by findings in the existing
literature that a single acceptance model poorly captures offer
acceptance behavior for specific patient groups. For example, Wood et al.
[@WoodPEDLSAM2021] note poor prediction for pediatric patients in LSAM.

To enable end users to change how graft offer acceptance decisions are
made, the odds ratios necessary for calculating the graft offer acceptance
probabilities are kept in csv files external to the program. Default
odds ratios supplied with the ELAS simulator were estimated based on
offers of whole liver grafts procured between January 1, 2012 and December 31, 2019.
When estimating these odds ratios, we ignored offers that were incompatible with
the allocation profiles of candidates and offers that were accepted
in non-standard allocation. To account for correlations in organ
acceptance behavior, odds ratios were estimated with mixed effect models. In these
models, we included random effects for donor heterogeneity (as in
[@agarwalEquilibriumAllocationsAlternative2021]), patient heterogeneity,
and center heterogeneity.

#### Simulation of non-standard allocation  {#sec:nonstandardalloc}

Approximately 25\% of livers are placed through non-standard allocation in
Eurotransplant. Without approximating such deviation from non-standard allocation,
the ELAS simulator would place too many grafts nationally in Belgium and Germany,
as both countries have implemented rules to prioritize local offers in
non-standard allocation. This motivated us to approximate deviation from standard allocation in the
graft offering module.

To address this, we approximate the initiation of non-standard allocation by

1.  simulating the maximum number of offers until non-standard allocation
    is initiated with a Cox proportional hazards model. This Cox model models
    the probability that non-standard allocation is triggered based on
    donor characteristics (malignancy, death cause, drug abuse, marginal
    donor criteria, virology), using the number of offers made as the timescale.
    The Cox model was stratified by donor country
    and blood group. The baseline hazards
    for this Cox proportional hazards model are shown in Figure \@ref(fig:ch5sfig5).

2.  offering the graft in the order of the match list, while maintaining a
    count of the number of offers made,

3.  if the maximum number of offers is reached

    -   stop offering the graft to candidates whose allocation
        profiles exclude rescue donors,

    -   give priority to regional candidates in Germany and
        to local candidates in Belgium.

In counting the number of offers made, a center-level rejection is
counted as a single offer, and a candidate-level rejection is counted
only if (a) the graft was compatible with the candidates allocation
profile and (b) the graft was previously rejected by fewer than five
candidate from the same center.

```{r ch5sfig5, fig.cap = chuck(CH5_FIG_CAPTIONS, 'SFIG5'), out.width = "100%", fig.pos='ht'}
FIG <- chuck(CH5_FIG_LIST, 'SFIG5')

if (knitr::is_html_output()) {
  knitr::include_graphics(paste0(FIG, '.png'))
} else if (knitr::is_latex_output()) {
  knitr::include_graphics(paste0(FIG, '.pdf'))
  
}
```

`\FloatBarrier`{=latex}

We note that this implementation is a heavily simplified representation of
non-standard allocation in Eurotransplant. Because candidates are still 
prioritized based on the match list order, this implementation is closer to
extended allocation than to rescue allocation (which operates on a first-come, first-served basis). Implementing competitive rescue allocation
was not pursued because (i) it is not clear from donor information alone when
competitive rescue allocation is initiated, (ii) there are three types of
competitive rescue allocation in Eurotransplant, and (iii) not all centers are willing to accept grafts via competitive rescue allocation [@ETLiverMan2025].

### The post-transplant module {#sec:elasposttxp}

Over 10% of liver waiting list registrations in Eurotransplant concern
candidates who are listed for a repeat liver transplantation. To
accurately simulate such re-listings, a post-transplant module was
implemented for the ELAS simulator. Upon transplantation, this
module simulates a time-to-failure $t$, defined as the time at which the
candidate would die in absence of re-transplantation. $T$ is modeled using
a Weibull distribution, with parameters for recipient and donor characteristics.
The module also simulates a time-to-relisting $r$, at which the candidate 
enlists for a repeat transplantation.
Finally, if a candidate is simulated to list for a repeat transplantation, 
the post-transplant module adds a listing for the repeat transplantation of
that candidate to the waiting list.
`\newpage`{=latex}
The parameters needed to simulate the post-transplant survival of liver transplantation
recipients were estimated on Eurotransplant liver transplantations between January 1, 2012
and December 31, 2019. Since we expected post-transplant survival and re-listing to
be different for elective candidates and those with the HU or ACO status, we estimated the
parameters separately for these groups.

#### Simulating time-to-failure for transplant recipients {#sec:elassimposttxp}

A Weibull model is used to simulate a time-to-event until patient death or
liver transplantation, separately for HU/ACO and elective candidates. 
The used Weibull distribution is parametrized with a shape
parameter $k$ and scale parameter 
`r if (knitr::is_latex_output()) '$\\lambda = \\beta^{\\T}x$'` `r if (!knitr::is_latex_output()) '$\\lambda = \\beta^{\\mathsf{T}}x,$'` where $x$ are relevant patient and
donor characteristics. The survival function for the Weibull distribution is given by:
`r if (knitr::is_latex_output()) '$$S(t|x) = \\exp\\Bigg(-\\Big(\\frac{t}{\\beta^{\\T}x}\\Big)^k\\Bigg).$$'`  
`r if (!knitr::is_latex_output()) '$$S(t|x) = \\exp\\Bigg(-\\Big(\\frac{t}{\\beta^{\\mathsf{T}}x}\\Big)^k\\Bigg).$$'`

After
obtaining estimates for $\beta$ and $k$ based on historical data using Weibull
regression, a time-to-event $t_i$ for a patient-donor pair $i$ can be simulated by inverse transform sampling from this distribution. Specifically, we can draw a random
number $u \sim \texttt{unif}(0,1)$ and simulate a patient's
time-to-event as
`r if (knitr::is_latex_output()) '$$t_i = \\hat{\\mathbf{\\beta}}^{\\T} \\mathbf{x_i} \\Big(-\\ln(u)^{\\frac{1}{k}}\\Big).$$'`  
`r if (!knitr::is_latex_output()) '$$t_i = \\hat{\\mathbf{\\beta}}^{\\mathsf{T}} \\mathbf{x_i} \\Big(-\\ln(u)^{\\frac{1}{k}}\\Big).$$'`

By default, post-transplant survival of elective candidates is simulated based
on a broad set of patient attributes (MELD biomarkers, patient age, country, sex, exception 
scores, BMI), donor attributes (year reported, donor age, split, DCD or DBD, death cause,
malignancy, tumor history), and match attributes (candidate-donor weight difference, travel time, 
blood group compatibility, match geography). Paucity of data on HU and ACO transplantations 
motivated us to adjust for fewer variables in the non-elective model (weight difference, 
donor death cause, donor age, patient age, lab-MELD score, match geography, and an
indicator for transplant history). Country-specific shape parameters are used to simulate $t$ for elective
candidates, while a single shape parameter is used to simulate it for candidates
with the HU or ACO status.
`\newpage`{=latex}

#### Simulating a time-to-relisting $r$ for transplant recipients {#sec:elassrelisting}

The simulation of a candidate's time-to-relisting is complicated by the fact that
a patient's time-to-relisting $r_i$ necessarily has to occur before their
time-to-failure $t_i$. To simulate re-listing times in the ELAS simulator, we 
estimated the probability of re-listing using the Kaplan-Meier estimator, with the 
time elapsed relative to the event time $t_i$ as the timescale. A 
re-listing time can then be simulated by inverse transform sampling from the
Kaplan-Meier curve, i.e., (i) 
sample a random $u \sim \text{unif}(0,1)$, (ii) choose the first $s$ such that $\mathbb{P}[R/T > s] \geq u$, and (iii)
calculate the time-to-relisting as $s \cdot t$.

In case no such $t$ exists, the patient will die without being listed for repeat
transplantation. The estimated empirical distribution of $R$ relative to $T$ is
shown in Figure \@ref(fig:ch5sfig6), stratified by discretized $T$. The figure
shows that the fraction of patients who have died without having listed for
repeat transplantation depends strongly on their time-to-failure $T$. For example, almost 70% of 
candidates who experience an event within one week after transplantation are
listed for a repeat liver transplantation, while only 20% of candidates
who experience an event more than five years after initial transplantation are
listed for repeat transplantation.

```{r ch5sfig6, fig.cap = chuck(CH5_FIG_CAPTIONS, 'SFIG6'), out.width = "100%", fig.pos='ht'}
FIG <- chuck(CH5_FIG_LIST, 'SFIG6')

if (knitr::is_html_output()) {
  knitr::include_graphics(paste0(FIG, '.png'))
} else if (knitr::is_latex_output()) {
  knitr::include_graphics(paste0(FIG, '.pdf'))
  
}
```

`\newpage`{=latex}

#### Construction of synthetic re-registrations {#sec:elassynthreg}

If a candidate is re-activated on the waiting list before
the simulation end date, i.e., $r$ < $t$, the post-transplant module adds a *synthetic* repeat
listing to the waiting list. This synthetic listing is 
generated by combining the fixed patient characteristics of the transplant recipient
with the dynamic status updates of a candidate who was actually
re-listed for transplantation. This re-listing is chosen such that the candidates (a) have
similar time-to-failure $t$ and similar time-to-relisting $r$, and (b) match on 
a pre-specified set of characteristics.

By default, the post-transplant module finds a matching re-registration
$k$ by:

1.  Considering re-listings where candidates match in terms of whether
    they were re-listed within 14 days^[Patients that are re-listed for liver
    transplantation within 14 days of transplantation can be eligible for an HU
    status under the current allocation rules [@ETLiverMan2025].] after transplantation,
    were listed in the same country, are similarly aged (<20 years difference),
    and have a similar time-to-relisting and time-to-event (both <1 year difference),

2.  Selecting from these potential re-listings the m=5 listings for repeat transplantation with the closest Mahalanobis
    distance between ($r_i$, $t_i$) and ($r_k$, $t_k$), and

3.  Sampling one re-listing at random from these $m$ re-listings.

A synthetic re-listing is then constructed by combining the patient
attributes from transplant recipient $i$ with status updates from patient $k$. 
The post-transplant module does not copy profile status updates from $k$ to $i$, as these allocation profiles are considered patient-specific. Exception scores from $k$ are copied only if both patients were listed in the same country, since certain (N)SEs are associated with listing for repeat transplantation (e.g., hepatic artery thrombosis).

## Verification and validation {#sec:elasvv}

The previous section described the design of the ELAS simulator and
its modules. In
this section, we describe our efforts to ensure that the ELAS simulator
adequately represents ELAS. For this, we distinguish between model
*verification*, which refers to efforts taken to identify coding errors in the
software, and model *validation*, which refers to efforts taken to assess whether
simulated outcomes closely approximate actual outcomes of Eurotransplant
liver allocation. For a general discussion of model verification and model
validation, we refer to Carson [@carsonVerificationValidationConsultants1989].

### Verification {#sec:elasverification}

The 2016 functional specifications for ELAS were consulted to implement the
liver allocation rules. The correctness of our implementation was verified by
exporting ELAS match lists for 500 donors reported between January 1, 2016 
and December 31, 2019, and testing whether match codes were correctly constructed
and whether We constructed unit tests to verify that
the ELAS simulator correctly generated the match codes for these lists based
on the reported donor and candidate information. We also constructed unit tests to
ascertain that the simulator returned candidates in exactly the same order as the exported match lists. To ensure the correctness of the exception module, we exported (N)SE
exception score definitions directly from the Eurotransplant database.
For the obligation system module, we used the functional specifications of
the ELAS obligation system to guide our implementation. These functional
specifications contain examples of how obligations have to be linked, including how to date the obligations that arise from multiple linkable
obligations. We implemented these examples as unit tests for the ELAS
simulator.

### Validation {#sec:elasvalidation}

Discrete-event simulators for organ allocation are typically validated
by comparing simulated statistics over a set time window to the actual
statistics from the same time period
[@ThompsonXSAM2004; @shechterClinicallyBasedDiscreteEvent2005]. Properties commonly
validated are the number of transplantations and waiting list deaths,
typically also stratified by patient groups. We follow this practice to 
validate the ELAS simulator. We do not use traditional hypothesis testing (or confidence intervals) to compare
simulated and actual statistics, as 
_"traditional hypothesis testing is not appropriate for measuring model validity 
because the null hypothesis that the true system and model are identical is almost 
always false"_
[@shechterClinicallyBasedDiscreteEvent2005]. In fact, any difference
between actually observed outcomes and simulations can be made
significant by increasing the number of simulation runs.
Instead, we give insight into the variability of ELAS simulator outputs
by reporting 95% interquantile ranges (95% IQRs) for simulation runs.
These interquantile ranges are obtained by simulating liver allocation
200 times, and reporting the 2.5th and 97.5th percentiles for simulated
outcomes of interest. When the real
summary statistic for an outcome of interest falls within the 95%
interquantile range, we say that the ELAS simulator is
*"well-calibrated"* for this outcome.

For input-output validation, we simulate Eurotransplant liver
allocation 200 times between January 1, 2016, and December 31, 2019.
The donor input stream consists of all 6,417 donors that were reported in this simulation window whose
livers were transplanted after allocation through ELAS. Characteristics of these
donors are shown in Table \@ref(tab:ch5tab1donors). The candidate input stream
consists of all patients who had an active waiting list status in the simulation 
period. These consist of n=7,137 patients who were activated on the waiting list in the
simulation window (see Table \@ref(tab:ch5tab1patlisted)),
and n=1,831 patients waiting on January 1, 2016 (see Table \@ref(tab:ch5tab1patincumbents)).

```{r ch5tab1donors, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB1_DONORS'), fig.pos='ht', results='asis'}
TAB_NAME <- 'TAB1_DONORS'

df_tab <- read_csv(chuck(CH5_TABLE_LIST, TAB_NAME))
names(df_tab)[1:2] <- c('Variable', 'Level')
  
df_tab <- mutate(
  df_tab, across(where(is.character), str_remove_all, ',')
) 
df_tab <- df_tab |>
  mutate(Variable = zoo::na.locf(Variable, na.rm=FALSE)) |>
  mutate_all(replace_na, '') |> select(-SMD) |> select(-p)

df_tab <- df_tab |>
  filter(!(Variable == 'marginal donor' & Level == 'no')) |>
  mutate(
    Variable = recode(
      Variable, 
      `UNOS-MELD score` = 'lab-MELD',
      `donor death cause` = 'death cause',
      `ET donor risk index` = 'ET-DRI'
    ),
    Level = recode(
      Level,
      heartbeating = 'HB',
      `non-heartbeating` = 'NHB',
      `Head trauma` = 'trauma',
      `F` = 'Female',
      `M` = 'Male'
    ),
    Variable = str_replace(Variable, 'delisting', 'exit')
)

df_tab <- df_tab |>
  mutate(
    across(where(is.character), str_replace_all, fixed('0 (0%)'), '–')
    )

df_tab$Level <- firstlow(df_tab$Level)
names(df_tab) <- firstlow(names(df_tab))

FOOTNOTE_TEXT <- "CVA, cerebrovascular accident; HB, heartbeating; NHB, nonheartbeating; ET-DRI, ET donor risk index."

FOOTNOTE_TEXT_HTML <- FOOTNOTE_TEXT

if (knitr::is_html_output()) {
  cat('<div class="table-scroll">\n')
  names(df_tab) <- unlist(df_tab[1,]) |> imap(~ paste(.y, tolower(.x), sep=' ')) |> trimws() |>
    str_replace('\\s', '<br>')
  df_tab[,3:9] <- df_tab[,3:9] |>
    mutate_all(str_replace, '\\s+', '<br>')
  pattern="\\[(\\d+\\.\\d+)-(\\d+\\.\\d+)\\]"
  df_tab[13,] <- df_tab[13,] |> str_replace_all(pattern, function(m) {
   
    # Extract matched numbers
    parts <- str_match(m, pattern)
    q1 <- round(as.numeric(parts[2]), 1)
    q3 <- round(as.numeric(parts[3]), 1)
  
  # Return with en dash and format
  sprintf("[%.1f-%.1f]", q1, q3)
  })
  df_tab$level <- recode(df_tab$level, `mean [Q1-Q3]` = 'mean<br>[Q1-Q3]')
  
  
  df_tab |>
    #plyr::rename(c(`Netherlands` = 'NL')) |>
    mutate(across(where(is.character), str_replace_all, '^-$', '\u2014')) |>
    kable(format='html', caption=chuck(CH5_TABLE_CAPTIONS, TAB_NAME), escape=FALSE, align='llccccccc') |>
    kable_styling(font_size=13) |>
    collapse_rows(columns = 1, valign = "middle") |>
    add_footnote(
      FOOTNOTE_TEXT_HTML, notation='none', escape=FALSE
      ) |>
    cat()
  cat('</div>')
} else if (knitr::is_latex_output()) {
  names(df_tab) <- unlist(df_tab[1,]) |> imap(~ paste(.y, tolower(.x), sep=' ')) |> trimws()
  
  lines <- df_tab |>
    filter(row_number() != 1) |>
    kable(format='latex', caption=chuck(CH5_TABLE_CAPTIONS, TAB_NAME), booktabs=TRUE, align='clccccccc') |>
    kable_styling(
      latex_options = c("scale_down", "hold_position"), font_size=10
    ) |>
    column_spec(1, width = "6em") %>%
    collapse_rows(columns = 1, valign = "middle", ) |>
    insert_footnote_manually(
      .text = FOOTNOTE_TEXT
    ) |>
    read_lines()
  lines <- gsub("([A-Za-z]+)\\s*\\(n=([0-9,]+)\\)", "\\\\makecell{\\1\\\\\\\\(n=\\2)}", lines)
  
  pattern <- "\\[(\\d+\\.\\d+)-(\\d+\\.\\d+)\\]"

  lines <- str_replace_all(
    lines,
      fixed('mean [Q1-Q3]'),
      '\\makecell[l]{mean\\\\ {[Q1-Q3]}}'
    ) |>
    str_replace_all(
      "([0-9.]+) \\[([^\\]]+)\\]", 
      "\\\\makecell{\\1\\\\\\\\ \\{[\\2]\\}}"
  )
  
  # Replace function to round both numbers
  lines <- str_replace_all(lines, pattern, function(m) {
   
    # Extract matched numbers
    parts <- str_match(m, pattern)
    q1 <- round(as.numeric(parts[2]), 1)
    q3 <- round(as.numeric(parts[3]), 1)
  
  # Return with en dash and format
  sprintf("[%.1f-%.1f]", q1, q3)
  })
  
  lines |> 
    paste0(collapse='\n') |>
    cat()
  }
```



```{r ch5tab1patlisted, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB1_DONORS'), fig.pos='ht', results='asis'}
TAB_NAME <- 'TAB1_PAT_LISTED'

df_tab <- read_csv(chuck(CH5_TABLE_LIST, TAB_NAME))
df_tab <- mutate(
  df_tab, across(where(is.character), str_remove_all, ',')
)

df_tab <- mutate(
  df_tab, across(where(is.character), str_remove_all, ',')
)


names(df_tab)[1:2] <- c('Variable', 'Level')
  
round_numbers <- function(x) {
  str_replace_all(x, "\\d+\\.\\d+", function(num) sprintf("%.0f", as.numeric(num)))
}

df_tab[6,] <- round_numbers(df_tab[6,])
df_tab[14,] <- round_numbers(df_tab[14,])

df_tab <- df_tab |>
  mutate(Variable = zoo::na.locf(Variable, na.rm=FALSE)) |>
  mutate_all(replace_na, '') |> select(-SMD) |> select(-p)

df_tab <- df_tab |>
  filter(!(Variable == 'marginal donor' & Level == 'no')) |>
  mutate(
    Variable = recode(
    Variable, 
    `UNOS-MELD score` = 'lab-MELD',
    `type donation` = 'type donor',
    `(N)SE` = 'exception at listing'
    ),
    Level = recode(
      Level,
    `F` = 'Female',
    `M` = 'Male',
    `exception` = 'yes',
    `non-exception` = 'no',
    `non-active` = 'inactive'
    ),
    Variable = str_replace(Variable, 'delisting', 'exit')
)

df_tab <- df_tab |>
  mutate(across(where(is.character), str_replace_all, fixed('0 (0%)'), '–'))

df_tab$Level <- firstlow(df_tab$Level)
names(df_tab) <- firstlow(names(df_tab))

FOOTNOTE_TEXT <- "(S)ALF, (Sub-)Acute Liver Failure; HCC, hepatocellular carcinoma; (N)SE, (non-)standard exception."

FOOTNOTE_TEXT_HTML <- FOOTNOTE_TEXT

if (knitr::is_html_output()) {
  cat('<div class="table-scroll">\n')
  names(df_tab) <- unlist(df_tab[1,]) |> imap(~ paste(.y, tolower(.x), sep=' ')) |> trimws() |>
    str_replace('\\s', '<br>')
  df_tab$level <- recode(df_tab$level, `mean [Q1-Q3]` = 'mean<br>[Q1-Q3]')
 df_tab[,3:9] <- df_tab[,3:9] |>
    mutate_all(str_replace, '\\s+', '<br>')
  df_tab |>
    mutate(across(where(is.character), str_replace_all, '^-$', '\u2014')) |>
    kable(format='html', caption=chuck(CH5_TABLE_CAPTIONS, TAB_NAME), align='llccccccc', escape=FALSE) |>
    kable_styling(font_size=13) |>
    collapse_rows(columns = 1, valign = "middle") |>
    add_footnote(
      FOOTNOTE_TEXT_HTML, notation='none', escape=FALSE
    ) |>
    cat()
  cat('</div>')
} else if (knitr::is_latex_output()) {
  names(df_tab) <- unlist(df_tab[1,]) |> imap(~ paste(.y, tolower(.x), sep=' ')) |> trimws()
  
  lines <- df_tab |>
    filter(row_number() != 1) |>
    #filter(variable != 'exit reason (1 year)') |>
    kable(format='latex', caption=chuck(CH5_TABLE_CAPTIONS, TAB_NAME), booktabs=TRUE, align='clccccccc') |>
    kable_styling(
      latex_options = c("scale_down", "hold_position"), font_size=10
    ) |>
    column_spec(1, width = "6em") %>%
    collapse_rows(columns = 1, valign = "middle", ) |>
    insert_footnote_manually(
      .text = FOOTNOTE_TEXT
    )
  
  lines <- str_replace_all(
    lines,
      fixed('mean [Q1-Q3]'),
      '\\makecell[l]{mean\\\\ {[Q1-Q3]}}'
    ) |>
    str_replace_all(
      "([0-9.]+) \\[([^\\]]+)\\]", 
      "\\\\makecell{\\1\\\\\\\\ \\{[\\2]\\}}"
  )
  
  lines <- gsub("([A-Za-z]+)\\s*\\(n=([0-9,]+)\\)", "\\\\makecell{\\1\\\\\\\\(n=\\2)}", lines)
  
  lines <- str_replace_all(lines,
                           'lab-MELD at listing', '\\\\makecell\\{lab-MELD\\\\\\\\at listing\\}')
  lines <- str_replace_all(lines,
                           fixed('listing age (years)'), '\\makecell{listing age\\\\(years)}')
    
  lines |>
    cat()
  }
```

`\newpage`{=latex}


```{r ch5tab1patincumbents, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB1_PAT_SIMSTART'), fig.pos='ht', results='asis'}
TAB_NAME <- 'TAB1_PAT_SIMSTART'

df_tab <- read_csv(chuck(CH5_TABLE_LIST, TAB_NAME))
names(df_tab)[1:2] <- c('Variable', 'Level')
df_tab <- filter(df_tab, replace_na(Level, 'na') != 'Missing')
vars <- df_tab$Variable

df_tab <- mutate(
  df_tab, across(where(is.character), str_remove_all, ',')
)
df_tab$Variable <- vars

round_numbers <- function(x) {
  str_replace_all(x, "\\d+\\.\\d+", function(num) sprintf("%.0f", as.numeric(num)))
}

df_tab[6,] <- round_numbers(df_tab[6,])
df_tab[14,] <- round_numbers(df_tab[14,])

df_tab <- df_tab |>
  mutate(Variable = zoo::na.locf(Variable, na.rm=FALSE)) |>
  mutate_all(replace_na, '') |> select(-SMD) |> select(-p)

df_tab <- df_tab |>
  filter(!(Variable == 'marginal donor' & Level == 'no')) |>
  mutate(
    Variable = recode(
    Variable, 
    `UNOS-MELD score` = 'lab-MELD',
    `type donation` = 'type donor',
    `(N)SE` = 'exception at listing'
    ),
    Level = recode(
      Level,
    `F` = 'Female',
    `M` = 'Male',
    `exception` = 'yes',
    `non-exception` = 'no',
    `non-active` = 'inactive'
    ),
    Variable = str_replace(Variable, 'delisting', 'exit')
)

df_tab[15:16,] <- df_tab[15:16,] |>
  mutate(across(where(is.character), str_replace_all, fixed('0 (0%)'), '-'))

df_tab$Level <- firstlow(df_tab$Level)
names(df_tab) <- firstlow(names(df_tab))

FOOTNOTE_TEXT <- "(S)ALF, (Sub-)Acute Liver Failure; HCC, hepatocellular carcinoma; (N)SE, (non-)standard exception."

FOOTNOTE_TEXT_HTML <- FOOTNOTE_TEXT

if (knitr::is_html_output()) {
  cat('<div class="table-scroll">\n')
  names(df_tab) <- unlist(df_tab[1,]) |> imap(~ paste(.y, tolower(.x), sep=' ')) |> trimws() |>
    str_replace('\\s', '<br>')
  df_tab$level <- recode(df_tab$level, `mean [Q1-Q3]` = 'mean<br>[Q1-Q3]')
  df_tab[,3:9] <- df_tab[,3:9] |>
    mutate_all(str_replace, '\\s+', '<br>')
  df_tab |>
    mutate(across(where(is.character), str_replace_all, '^-$', '\u2014')) |>
    kable(format='html', caption=chuck(CH5_TABLE_CAPTIONS, TAB_NAME), align='llccccccc', escape=FALSE) |>
    kable_styling(font_size=14) |>
    collapse_rows(columns = 1, valign = "middle") |>
    add_footnote(
      FOOTNOTE_TEXT_HTML, notation='none', escape=FALSE
      ) |>
    cat()
  cat('</div>\n')
} else if (knitr::is_latex_output()) {
  names(df_tab) <- unlist(df_tab[1,]) |> imap(~ paste(.y, tolower(.x), sep=' ')) |> trimws()
  
  lines <- df_tab |>
    filter(row_number() != 1) |>
    #filter(variable != 'exit reason (1 year)') |>
    kable(format='latex', caption=chuck(CH5_TABLE_CAPTIONS, TAB_NAME), booktabs=TRUE, align='clccccccc') |>
    kable_styling(
      latex_options = c("scale_down", "hold_position"), font_size=10
    ) |>
    column_spec(1, width = "6em") %>%
    collapse_rows(columns = 1, valign = "middle", ) |>
    insert_footnote_manually(
      .text = FOOTNOTE_TEXT
    )
  
  # Fix n = 
  lines <- gsub("([A-Za-z]+)\\s*\\(n=([0-9,]+)\\)", "\\\\makecell{\\1\\\\\\\\(n=\\2)}", lines)
  
  # Force date on newline
  lines <- str_replace_all(lines, "([\\)\\(\\w\\\\\\-]+?)\\s*(\\(Jan 1, 2016\\))", "\\\\makecell\\{\\1 \\\\\\\\ \\2\\}")
  
  # Fix listing age
  lines <- str_replace_all(lines,
                           fixed('listing age (years)'), '\\makecell{listing age\\\\(years)}')
  
  lines <- str_replace_all(
    lines,
      fixed('mean [Q1-Q3]'),
      '\\makecell[l]{mean\\\\ {[Q1-Q3]}}'
    ) |>
    str_replace_all(
      "([0-9.]+) \\[([^\\]]+)\\]", 
      "\\\\makecell{\\1\\\\\\\\ \\{[\\2]\\}}"
  )
  
  lines |>
    cat()
  }
```

`\FloatBarrier`{=latex}
These counts do not include candidates who were transplanted with a living
donor as ELAS is only used to allocate deceased-donor livers. We also excluded
candidates whose country of listing changed (29 listings in total). For
simulation, we use actual donor arrival times and actual candidate
status histories, which were completed with the status completion 
procedure described in Appendix \@ref(APPimputation). For each of the 200 simulation runs, a
different file of completed candidate status updates is used. These files differ
in the completed status update trajectories per candidate.

Table \@ref(tab:ch5tab2) shows the validation results for waiting list outcomes. This table shows that the ELAS simulator
is well-calibrated for the number of 
split liver transplantations, the number of total listings and those for a repeat transplantation, the number of waiting list
removals, and the number of waiting list deaths. A statistic for which
the simulator is not well-calibrated is the active waiting list size at
simulation termination, which is 4.5% larger in simulations than
in reality. The ELAS simulator is well-calibrated for the number of
waiting list
deaths per country, except for in Germany where the number of waiting
list deaths is underestimated by 52 deaths (-8.1%), on average, over the 200
simulations. 
Inspecting waiting list deaths by groupings of the lab-MELD score shows that the ELAS simulator
underestimates the number of waiting list deaths in candidates with the
highest MELD scores (-8.1% for MELD 31--40) and HU / ACO candidates
(-27.2%), while the simulator overestimates the number of waiting list
deaths in candidates with low MELD scores (+11.8% for MELD 6--10).


```{r ch5tab2, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB2')}
if (knitr::is_html_output()) {
  row_packing <- c(
    `deceased-donor livers` = 4,
    `waiting list` = 5,
    `waiting list mortality by country` = 7,
    `waiting list mortality by urgency` = 5
  )
  
  readLines(chuck(CH5_TABLE_LIST, 'TAB2')) |>
    purrr::keep(function(.x) str_detect(.x, '&')) |>
    tail(-2) |>
    str_remove_all('\\t') |>
    str_remove_all('\\\\') |>
    str_remove_all('$') |>
    str_remove_all(fixed('hspace{1em}')) |>
    paste0(collapse = '\n') |>
    read_delim('&', col_names = c('category', 'sim', 'real')) |>
    mutate(category = trimws(category, whitespace='%') |> firstlow()) |>
    setNames(
      c(' ', 'simulated results<br>(average and 95% IQR)', 'actual<br>(2016-2019)')
    ) |>
    mutate_all(str_remove, fixed('%')) |>
     mutate_all(
      function(.x) if_else(
        str_detect(.x, 'textbf'), cell_spec(str_extract(.x, '(?<=\\{).+(?=\\})'), bold=TRUE), .x
      )
    ) |>
    kable(format='html', escape=FALSE, align='lcc') |>
    pack_rows(index = row_packing)
} else if (knitr::is_latex_output()) {
  wrap_table(
    chuck(CH5_TABLE_LIST, 'TAB2'),
    my_label = 'tab:ch5tab2',
    my_caption = chuck(CH5_TABLE_CAPTIONS, 'TAB2'),
    scale_down=TRUE,
    scale_factor=.90
  )
}
```

`\FloatBarrier`{=latex}

Table \@ref(tab:ch5tab3) shows validation results relating
to transplantations, separately for standard and non-standard
allocation. The ELAS simulator is well-calibrated for most
summary statistics, including the number of placements through each
allocation mechanism, as well as the number of transplantations 
stratified by pediatric status and candidate sex. 
The simulator is not well-calibrated for the number
of transplantations within all Eurotransplant countries.
In total, 55 too many
transplantations ($+4.2\%$) are performed in the simulations in Belgium, while 
on average 35 (-5.6\%) and 15 (-3.0\%) too few transplantations are simulated in Austria
and Croatia, respectively. Restricting attention to standard allocation, we find that
too few grafts are accepted in Austria (-6.8\%), Croatia (-6.0\%) and Hungary (-7.4\%).
Generally, too few grafts are accepted locally or regionally in simulations (-15\%).

`\FloatBarrier`{=latex}

`\begingroup`{=latex}
`\setlength{\aboverulesep}{0.2ex}`{=latex}
`\setlength{\belowrulesep}{0.3ex}`{=latex}

```{r ch5tab3, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB3'), results='asis'}
if (knitr::is_html_output()) {
  row_packing <- c(
    `allocation mechanism` = 4,
    `recipient characteristics` = 3,
    `match geography` = 10,
    `MELD type (non-HU / ACO only)` = 4,
    `match-MELD (adult non-HU / ACO only)` = 5,
    `lab-MELD (adult non-HU / ACO only)` = 5
  )
  
  readLines(chuck(CH5_TABLE_LIST, 'TAB3')) |>
    purrr::keep(function(.x) str_detect(.x, '&')) |>
    tail(-2) |>
    str_remove_all('\\t') |>
    str_remove_all('\\\\') |>
    str_remove_all('$') |>
    str_remove_all(fixed('hspace{.7em}')) |>
    paste0(collapse = '\n') |>
    read_delim('&', col_names = c('category', 'sim', 'real')) |>
    tail(-1) |>
    mutate_all(str_remove, fixed('%')) |>
    mutate_all(
      function(.x) if_else(
        str_detect(.x, 'textbf'), cell_spec(str_extract(.x, '(?<=\\{).+(?=\\})'), bold=TRUE), .x
      )
    ) |>
    mutate_all(
      str_replace,
      fixed('Plus'),
      '+'
    ) |>
    mutate_all(
      function(.x) if_else(trimws(.x) == '-', '\u2011', .x)
    ) |>
    mutate(
      across(where(is.character), str_replace, 'textemdash', '\u2011')
    ) |>
    setNames(
      c(' ', 'simulated results<br>(average and 95% IQR)', 'actual<br>(2016-2019)',
        'simulated results<br>(average and 95% IQR)', 'actual<br>(2016-2019)')
    ) |>
    kable(format='html', escape=FALSE, align='lcccc') |>
    kable_styling(font_size=15) |>
    add_header_above(
      c(` ` = 1, `standard allocation` = 2, `non-standard allocation` = 2)
    ) |>
    pack_rows(index = row_packing)
} else if (knitr::is_latex_output()) {
  lines <- wrap_table(
    chuck(CH5_TABLE_LIST, 'TAB3'),
    my_label = 'tab:ch5tab3',
    my_caption = chuck(CH5_TABLE_CAPTIONS, 'TAB3'),
    pos='b',
    scale_down=TRUE,
    scale_factor=1
  ) |> 
    read_lines()
  
  lines |> 
    append('\\small', after = 2) |>
    paste0(collapse ='\n') |>
    cat()
}
```

`\endgroup`{=latex}

`\FloatBarrier`{=latex}

Regarding transplantations categorized by type of exception, 
we find that the
ELAS simulator is well-calibrated for the number of transplantations in
non-exception candidates and in candidates with SE other than HCC.
The total number of transplantations with HCC is overestimated by 40 on average
(+3.5\%), but is well-calibrated if attention is restricted to standard allocation. The simulator
underestimates the number of transplantations in candidates with NSEs,
both in standard allocation (-17.5\%) and in total (-9.5\%).

In terms of the number of transplantations per MELD score via standard allocation, the ELAS
simulator appears to be mostly well-calibrated, with
only the number of transplantations in candidates with lab-MELD scores between 6
and 10 underestimated (-8.6\%) and those in candidates with match-MELD between
31 and 40 overestimated (+11.8\%). Additional differences emerge when we also
include transplantations which followed non-standard allocation: the ELAS simulator 
then generally underestimates the number of transplantations in candidates with low 
MELD scores (MELD: 6–10) and overestimates the number of transplantations
in those with high MELD scores (MELD: 21–30 and 31–40).

#### Validation of post-transplant outcomes {#sec:elasposttransplant}

Figure 
\@ref(fig:ch5fig2) compares the simulated
post-transplant event rates with the actual post-transplant event rates,
estimated per country at several time horizons. These $t$-day
post-transplant survival probabilities were estimated with the Kaplan-Meier
estimator. The simulated event rates are close to the actual event rates in all
Eurotransplant regions. Only in Croatia and Slovenia, the simulated
post-transplant event rates appear to be slightly biased downwards.
Figure \@ref(fig:ch5sfig1) shows that the estimated re-listing
probabilities are also comparable to the observed re-listing probabilities.

```{r ch5fig2, fig.cap = chuck(CH5_FIG_CAPTIONS, 'FIG2'), out.width = "90%"}
FIG <- pluck(CH5_FIG_LIST, 2)

if (knitr::is_html_output()) {
  knitr::include_graphics(paste0(FIG, '.png'))
} else if (knitr::is_latex_output()) {
  knitr::include_graphics(paste0(FIG, '.pdf'))
  
}
```

`\FloatBarrier`{=latex}

```{r ch5sfig1, fig.cap = chuck(CH5_FIG_CAPTIONS, 'SFIG1'), out.width = "90%"}
FIG <- chuck(CH5_FIG_LIST, 'SFIG1')

if (knitr::is_html_output()) {
  knitr::include_graphics(paste0(FIG, '.png'))
} else if (knitr::is_latex_output()) {
  knitr::include_graphics(paste0(FIG, '.pdf'))
  
}
```
`\FloatBarrier`{=latex}

#### Discussion of validation results {#sec:valelasdiscussion}

The ELAS simulator appears to be well-calibrated for most waiting list
and transplantation patterns within Eurotransplant. An important
exception is the total number of transplantations and waiting list exits 
by lab- and match-MELD score. For example, the simulator overestimates
the total number of transplantations among candidates with high urgency 
(MELD 31--40 or HU/ACO status), and underestimates the number of waiting list
deaths in this group (see Tables \@ref(tab:ch5tab2) and \@ref(tab:ch5tab3)).
Table \@ref(tab:ch5tab3) shows that such miscalibration is present to a much
lesser degree in standard allocation, with the number of transplantations only
slightly overestimated for candidates with the highest match-MELD scores (31-40)
and the lowest lab-MELD scores (6-10). 

A potential explanation for this miscalibration is that the simulator 
assumes that candidates who accept a liver graft offer are always transplanted. 
In practice, however, transplant centers can cancel transplantation
procedures after an initial acceptance, for example because of logistical
issues, unfavorable histopathology findings, or instability of the
transplant candidate. In such cases, Eurotransplant can re-offer 
the graft to candidates who are located in the
vicinity of the graft via extended or rescue allocation. This generally
results in the placement of livers in candidates with lower urgency, 
particularly in the case of rescue allocation, which operates on a first-come, 
first-serve basis. We note that such rescue
allocation was not implemented for the ELAS simulator. 

To assess whether competitive rescue allocation could partially explain the observed
miscalibration, we inspected the placements of the 241 liver grafts procured from
donors in the simulation period that were initially accepted by one candidate, declined
before transplantation, and then re-offered to other candidates via competitive
rescue allocation. For these 241 livers, Table \@ref(tab:tabcomprescue) shows the MELD scores of
the initially accepting candidate and final transplant recipient. In general, 
re-offering via rescue allocation indeed leads
to lower MELD scores at transplantation, providing a partial explanation for the
miscalibration in low-MELD groups in Table \@ref(tab:ch5tab2) and \@ref(tab:ch5tab3).

A second outcome on which the simulator is not well-calibrated is the
number of transplantations per country. For example, in Belgium there
are on average 55 (+4%) more transplantations in simulations than in
reality. This may also be explained by the lack of competitive rescue
allocation, through which approximately 10--15
grafts are transferred per year from Belgium to Germany. The fact that
too many grafts are transplanted in Belgium may also explain why the
number of transplantations in candidates with HCC is overestimated 
(see Table \@ref(tab:ch5tab3)), as Belgium has the highest proportion of
candidates that are listed with HCC. This seems supported by the fact that no 
miscalibration is observed for the number of transplants within candidates with 
HCC when restricting to livers allocated via standard allocation only 
(see Table \@ref(tab:ch5tab3)).


```{r tabcomprescue, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TABCOMPRESCUE'), fig.pos='h', results='asis'}
TAB <- chuck(CH5_TABLE_LIST, 'TABCOMPRESCUE')

tab <- read_excel(TAB)
HEADER <- c(` ` = 1, `initially accepting candidate` = 2, `final liver recipient` = 2)
colnames(tab) <- str_remove_all(colnames(tab), '\\.+[0-9]')

if (knitr::is_html_output()) {
  kable(tab, format='html', align='lcccc') |>
    
    add_header_above(
      HEADER
    )
  
} else if (knitr::is_latex_output()) {
  
  wrap_table(
    chuck(CH5_TABLE_LIST, 'TABCOMPRESCUE') |> str_replace('xlsx', 'tex'),
    my_label = 'tab:tabcomprescue',
    my_caption = chuck(CH5_TABLE_CAPTIONS, 'TABCOMPRESCUE'),
    pos='h',
    scale_down = TRUE,
    scale_factor = .9
  ) |>
    read_lines() |>
    #append('\\color{red}', after = 1) |> 
    paste0(collapse ='\n') |>
    cat()
}
```

`\newpage`{=latex}
We thus have two potential explanations for miscalibration of the ELAS
simulator, which are (i) the simulator does not allow planned
transplantation procedures to be cancelled after an initial acceptance,
and (ii) the simulator does not implement competitive rescue allocation.
We have chosen not to implement these two mechanisms in the ELAS
simulator because (i) the focus of policy discussions in ELIAC is standard
allocation, not competitive rescue allocation, (ii) cancellations after an
initial acceptance are relatively rare (about 4% of transplantations),
and (iii) the decision to proceed with rescue allocation is made on a case-by-case
basis, which is difficult to model correctly because of the limited availability
of structured data on rescue allocation. In our view, the simulated outcomes are 
sufficiently close to observed outcomes to make the ELAS simulator useful 
for policy evaluation. We illustrate this in Section \@ref(sec:elascasestudies) 
with two case studies.
`\vspace*{-1em}`{=latex}

## Case studies: the impact of modifying ELAS rules {#sec:elascasestudies}

With two case studies, we illustrate that the ELAS simulator can be used
for quantifying the impact of liver allocation policy changes. For the first case study (Section
\@ref(sec:elasbeliaccasestudy)), we
collaborated with representatives from the Belgian Liver and Intestine
Advisory committee (BeLIAC) to study the impact of changes to the
Belgian exception score system. In the second case study (Section \@ref(sec:elasremeldcasestudy)), we study the
impact of basing Eurotransplant liver allocation on ReMELD-Na scores
instead of UNOS-MELD scores, which was a topic on the agenda of ELIAC in
2023.

To evaluate these ELAS policy changes, we simulate Eurotransplant liver
allocation 50 times between January 1, 2016, and December 31, 2019, and compare
the outcomes simulated under the modified ELAS rules to the outcomes simulated
under the current ELAS rules. We test whether modified policies lead to
significantly different outcomes with traditional hypothesis testing. To
increase the power of these tests, we use common random number
generators [@lawSimulationModelingAnalysis2015] to eliminate any variance that is
attributable to factors which we
assume to be independent from the allocation policy. Specifically, we use common random
numbers to synchronize the splitting of liver grafts, the graft offer
acceptance behavior of candidates, and the triggering of rescue
allocation across policies for each of the 50 replications. By
synchronizing these processes across policies, pairwise t-tests can be used
to establish the statistical significance of the impact of policy changes.

### Case study 1: the exception score system in Belgium {#sec:elasbeliaccasestudy}

Nearly half of the liver transplant candidates that are listed in Belgium
receive exception points, which makes Belgium the country with relatively 
most awarded (N)SEs in Eurotransplant. Most of these (N)SEs increase with every 
90 days of waiting time, which increases the match-MELD score that elective
candidates require in Belgium to be offered a liver graft. This has led to
concerns that candidates without exception points are crowded out of transplantation.

To address this, the BeLIAC has considered imposing a cap on (N)SE-MELDs
of 30, which corresponds to maximizing the awardable 90-day mortality
equivalent with a 50% mortality equivalent. In joint discussions, the 
BeLIAC also expressed an interest in capping (N)SE-MELDs at 25, as well as
alternative policy options. These alternatives were slowing down (N)SE-MELDs by
reducing the 90-day increments (referred to as "*slower*" policies), and lowering
the initial mortality equivalents awarded for (N)SEs (referred to as
"*lowered*" policies). Table \@ref(tab:ch5tab4) provides an overview
of the policy options discussed within BeLIAC.

At the request of BeLIAC, these policy alternatives were evaluated with the
ELAS simulator. Figure \@ref(fig:ch5fig3) and 
Table \@ref(tab:ch5tab5) summarize the results, which both focus on livers
from DBD donors (DCD donors are center offers in Belgium). Figure
\@ref(fig:ch5fig3) visualizes the distributions of the simulated
(N)SE-MELD scores at DBD transplantation for exception candidates (left),
and laboratory MELD scores at DBD transplantation for non-exception
candidates (right). The figure shows that capping (N)SE-MELDs at 30
barely affects their distribution at transplantation, while the other 
policy alternatives reduce the median (N)SE-MELD at transplantation by up to 4 points
on the MELD scale (left side).
It also shows that lab-MELD scores at DBD transplantation for non-exception
candidates become lower when (N)SEs are capped (right side). In fact, 
the median lab-MELD at DBD transplantation
becomes up to 3 MELD points lower with *slower* and *lowered* policies, than the median observed under the current allocation rules. These alternative policies thus increase access to
transplantation for candidates with lab-MELD scores between 20 and 23,
which may be desired as they face a 90-day
mortality risk between 10 to 15%.

`\newpage`{=latex}

```{r ch5tab4, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB4'), results='asis'}
FOOTNOTE_TEXT <- 'Set to the initial equivalent if the initial equivalent exceeds the proposed cap. For example, candidates with biliary atresia maintain a 60\\% mortality equivalent.'

if (knitr::is_html_output()) {

  readLines(chuck(CH5_TABLE_LIST, 'TAB4')) |>
    purrr::keep(function(.x) str_detect(.x, '&')) |>
    tail(-1) |>
    str_remove_all('\\t') |>
    str_remove_all('\\\\') |>
    str_remove_all('$') |>
    str_remove_all(fixed('hspace{1em}')) |>
    
    str_remove_all(fixed('bottomrule')) |>
    str_remove_all(fixed('allowbreak ')) |>
    str_remove_all('\\[.+\\]') |>
    str_replace('textless\\{\\}', 'less than ') |>
    paste0(collapse = '\n') |> 
    read_delim('&', col_names = c('policy', 'initial equivalent', '90-day increment', 'maximum equivalent')) |>
    mutate(`initial equivalent` = str_replace(`initial equivalent`, fixed(', 15%'), ',<br>15%')) |>
    mutate(`90-day increment` = str_replace(`90-day increment`, '\\(', '<br>(')) |>
    mutate(`maximum equivalent` = str_replace(`maximum equivalent`, '\\(', '<br>(')) |>
    mutate_all(
      function(.x) if_else(trimws(.x) == '-', '\u2011', .x)
    ) |>
    kable(format='html', escape=FALSE, align='lcccc') |>
    kable_styling(c('striped')) |>
    add_footnote(
      FOOTNOTE_TEXT
    )
} else if (knitr::is_latex_output()) {
  wrap_table(
    chuck(CH5_TABLE_LIST, 'TAB4'),
    my_label = 'tab:ch5tab4',
    my_caption = chuck(CH5_TABLE_CAPTIONS, 'TAB4'),
    pos='h'
  ) |>
    insert_footnote_manually(
      .text = paste0('$^a$', FOOTNOTE_TEXT)
    ) |>
    cat()
}
```

```{r ch5fig3, fig.cap = chuck(CH5_FIG_CAPTIONS, 'FIG3'), out.width = "100%"}
FIG <- pluck(CH5_FIG_LIST, 3)

if (knitr::is_html_output()) {
  knitr::include_graphics(paste0(FIG, '.png'))
} else if (knitr::is_latex_output()) {
  knitr::include_graphics(paste0(FIG, '.pdf'))
  
}
```

`\FloatBarrier`{=latex}
`\newpage`{=latex}
Table \@ref(tab:ch5tab5) shows summary statistics for the simulated waiting list outcomes,
separately for exception and non-exception candidates. Comparing the third column (actual 2016-2019 statistics) to
the fourth column (averages and 95% IQRs over the 50 simulations) shows that
the ELAS simulator is well-calibrated for the number of
transplantations, waiting list deaths, and waiting list exits. This
reassures us that the ELAS simulator reasonably describes these
allocation patterns. Of policy interest are the remaining columns of
Table \@ref(tab:ch5tab5), which show for every (N)SE policy alternative 
the average number of events over the 50 simulations. Comparing
these outcomes to the outcomes simulated under current (N)SE rules shows
that almost all policies significantly change the number of
transplantations, the number of waiting list deaths, and the number of
waiting list removals.

The greatest effects are sorted by combining the *slowest* and *lowered* policies
(final column), with which on average 20 (+5%) extra candidates without exception
points are transplanted. According to the simulation results, this policy could 
have avoided 12 waiting list deaths in non-exception candidates in Belgium (-10%), 
which corresponds to 3 waiting list deaths per year. The cost of this policy change
is that we see a slight increase in the number of waiting list removals for
exception patients, with on average 1--2 extra exception patients per year 
removed because they became unfit for transplantation, or because they had HCC 
or another form of cancer. 

`\begingroup`{=latex}
`\sisetup{range-phrase = {\,\textemdash\,}}`{=latex}

```{r ch5tab5, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB5')}
if (knitr::is_html_output()) {
  
  fix_current_sim <- function(.x) {
    str_extract_all(.x, '[0-9]+') |>
      map(tail, 3) |>
      map_chr(~ glue::glue('{.x[[1]]} [{.x[[2]]}-{.x[[3]]}]'))
  }

  d_t <- readLines(chuck(CH5_TABLE_LIST, 'TAB5')) |>
    purrr::keep(function(.x) str_detect(.x, '&')) |>
    tail(-1) |>
    str_remove_all('\\t') |>
    str_remove_all('\\\\') |>
    str_remove_all('$') |>
    str_remove_all(fixed('hspace{1em}')) |>
    
    str_remove_all(fixed('bottomrule')) |>
    str_remove_all(fixed('allowbreak ')) |>
    str_replace('textless\\{\\}', 'less than ') |>
    paste0(collapse = '\n') |> 
    read_delim('&', col_names = c('Exit reason', 'Patient type', 'Current (real)', 'Current (sim)', 'Capped (30)', 'Capped 25', 'Slower', 'Slower & capped (25)', 'Slowest', 'Slowest & capped (25)', 'Slower & lowered', 'Slowest & lowered', 'Slowest & lowered')) |>
    mutate(
      `Current (sim)` = fix_current_sim(`Current (sim)`),
      `Exit reason` = str_remove_all(`Exit reason`, '.+backslash') |>
        str_remove_all('\\}') |>
        str_remove_all('makecell\\{') |>
        str_replace('Removed', 'Removed ') |>
        str_replace('listdeath', 'list death') |>
        str_replace('removedHCC', 'removed HCC'),
      `Exit reason` = if_else(nchar(`Exit reason`) == 1, NA_character_, `Exit reason`),
      `Exit reason` = rev(zoo::na.locf(rev(`Exit reason`)))
    ) |>
    pivot_longer(
      -c(`Exit reason`, `Patient type`),
      names_to='Policy'
    ) |>
    pivot_wider(
      names_from = `Exit reason`
    ) |>
    dplyr::rename_with(firstlow)
  names(d_t) <- names(d_t) |> str_wrap(width=6) |> str_replace_all('\n', "<br>")
  d_t |>
    kable(format='html', escape=FALSE, align='llcccc') |>
    kable_styling('striped', font_size=15) |>
    collapse_rows(1) |>
    add_p_value_footnote()
    
} else if (knitr::is_latex_output()) {
  wrap_table(
    chuck(CH5_TABLE_LIST, 'TAB5'),
    my_label = 'tab:ch5tab5',
    my_caption = chuck(CH5_TABLE_CAPTIONS, 'TAB5'),
    pos='h'
    )  |>
    str_split('\n') |> unlist() |>
    insert_footnote_manually(.text = "$^{*}$ p < 0.05, $^{**}$ p < 0.01, $^{***}$ p < 0.001") |>
    knitr::asis_output()
}
```

`\endgroup`{=latex}

`\FloatBarrier`{=latex}
`\vfill`{=latex}

### Case study 2: basing Eurotransplant liver allocation on ReMELD-Na {#sec:elasremeldcasestudy}

Candidates with hyponatremia, i.e. low serum sodium levels, face systematically
higher waiting list mortality rates than suggested by
their MELD score [@kimHyponatremiaMortalityPatients2008a]. To adequately
prioritize these patients, MELD-Na was introduced in 2016 for liver allocation
in the United States. In 2020, Goudsmit et aFl. revised this MELD-Na score with retrospective
data from Eurotransplant, leading to the _ReMELD-Na_ score.

In May 2023, the ELIAC recommended basing Eurotransplant liver allocation
on ReMELD-Na instead of UNOS-MELD. A matter of concern for ELIAC was
that ReMELD-Na scores range from 1 to 36, while UNOS-MELD scores range
from 6 to 40. Basing laboratory MELD scores on ReMELD-Na without
updating the MELD-curve could therefore mean that non-exception
candidates -- who depend on lab-MELD for access to transplantation -- could
only receive match-MELD scores up to 36, while candidates with (N)SE
or PED-MELD scores could still receive match-MELD scores up to 40. A
switch to ReMELD-Na could thereby inadvertently give extra priority to
candidates with exception points, who already appear to have an advantage in ELAS
[@umgelterDisparitiesEurotransplantLiver2017a].

To support this discussion, we simulated two scenarios for liver allocation using
ReMELD-Na. For both scenarios, lab-MELD scores were based on ReMELD-Na, calculated
using:

$$
\begin{aligned}
\text{ReMELD-Na} &= 7.85 + 9.03\ln(\text{crea}) + 2.97\ln(\text{bili}) + 9.52\ln(\text{INR}) + \\
& 0.392(138.6 - \text{Na}) - 0.351(138.6 - \text{Na})\ln(\text{crea}).
\end{aligned}
$$

In the first scenario, the exception score system remained unchanged,
which means that PED-MELD and (N)SE-MELD scores are calculated based on
the UNOS-MELD survival curve. This curve is given by the following
formula:

$$
S_{90}^{\texttt{UNOS-MELD}} = 0.98037^{0.17557(\texttt{UNOS-MELD} - 10)}.
$$


In the second scenario, PED-MELD and (N)SE-MELD scores are instead
calculated based on a survival curve developed specifically for
ReMELD-Na. This curve was obtained by estimating a Cox proportional hazards
model on Eurotransplant registry data using ReMELD-Na as the only covariate.
The obtained ReMELD-Na curve is given by the following formula:

$$
S_{90}^{\text{ReMELD-Na}} = 0.9745^{0.2216(\text{ReMELD-Na} - 10)}.
$$

`\newpage`{=latex}
Table \@ref(tab:ch5tab6) shows simulated waiting list outcomes under
these ReMELD-Na policies, summarized over 50 simulations. The
third column shows that introducing ReMELD-Na without updating the
S-curve results in approximately 70 extra waiting list deaths in total
(p < 0.001), which corresponds to 15--20 extra waiting list deaths per
year. This finding is likely explained by ELIAC's concern that a switch
to ReMELD-Na inadvertently deprioritizes candidates who depend on
lab-MELD scores for access to transplantation. The fourth column shows
that switching to ReMELD-Na with the updated S-curve could have averted
25 waiting list deaths in total (p < 0.001).



```{r ch5tab6, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB6')}
if (knitr::is_html_output()) {
  
  readLines(chuck(CH5_TABLE_LIST, 'TAB6')) |>
    purrr::keep(function(.x) str_detect(.x, '&')) |>
    tail(-1) |>
    str_remove_all('\\t') |>
    str_remove_all('\\\\') |>
    str_remove_all('$') |>
    str_remove_all(fixed('hspace{1em}')) |>
    
    str_remove_all(fixed('bottomrule')) |>
    str_remove_all(fixed('allowbreak ')) |>
    str_replace('textless\\{\\}', 'less than ') |>
    paste0(collapse = '\n') |> 
    read_delim('&', col_names = c('exit reason', 'UNOS-MELD (current)', 'ReMELD-Na<br>(old S-curve)', 'ReMELD-Na<br>(updated S-curve)')) |>
    mutate_all(
      str_remove_all, '(?<=[0-9])\\.[0-9]'
    ) |>
    kable(format='html', escape=FALSE, align='lccc') |>
    kable_styling('striped') |>
    add_p_value_footnote()
} else if (knitr::is_latex_output()) {
  wrap_table(
    chuck(CH5_TABLE_LIST, 'TAB6'),
    my_label = 'tab:ch5tab6',
    my_caption = chuck(CH5_TABLE_CAPTIONS, 'TAB6')) |>
    str_split('\n') |> unlist() |>
    insert_footnote_manually(.text = "$^{*}$ p < 0.05, $^{**}$ p < 0.01, $^{***}$ p < 0.001") |>
    knitr::asis_output()
}
```

An important limitation of this analysis is that serum sodium
measurements are not available for most candidates in Eurotransplant
registry data. When serum sodium was missing in simulations, we
calculated ReMELD-Na scores with a serum sodium level of 138.6 mmol/l, 
which results in 0 points being awarded for hyponatremia. Because this 
means that hyponatremia could not be prioritized in all
candidates, the reduction of 25 waiting list deaths is a
conservative projection.

Whether serum sodium is reported to Eurotransplant depends primarily on
the candidate's listing center, because the transplant centers either never or
almost always report serum sodium to Eurotransplant. This motivated us to also assess
the number of waiting list deaths stratified by the listing center's track record of reporting serum sodium. For this, we
categorize centers into centers with high, medium and low serum sodium
completeness. Table
\@ref(tab:ch5tab7) shows the total number of
waiting list deaths per type of center. It can be seen that the
reduction in waiting list deaths is indeed concentrated in centers with
high serum sodium completeness, with 28 fewer waiting list deaths observed
in such centers. Under the (optimistic) assumption that this reduction in
waiting list deaths is representative for all centers in Eurotransplant,
using ReMELD-Na as the basis for liver allocation could have prevented
up to 80 waiting list deaths over the simulation period.


```{r ch5tab7, tab.cap=chuck(CH5_TABLE_CAPTIONS, 'TAB7')}
if (knitr::is_html_output()) {
  
  readLines(chuck(CH5_TABLE_LIST, 'TAB7')) |>
    purrr::keep(function(.x) str_detect(.x, '&')) |>
    tail(-1) |>
    str_remove_all('\\t') |>
    str_remove_all('\\\\') |>
    str_remove_all('$') |>
    str_remove_all(fixed('hspace{1em}')) |>
    
    str_remove_all(fixed('bottomrule')) |>
    str_remove_all(fixed('allowbreak ')) |>
    str_replace('textless\\{\\}', 'less than ') |>
    paste0(collapse = '\n') |> 
    read_delim('&', col_names = c('sodium completeness', 'centers', 'patients', 'waiting list deaths<br>under UNOS-MELD', 'waiting list deaths<br>under ReMELD-Na<br>(updated S-curve)')) |>
    mutate_all(
      str_remove_all, '(?<=[0-9])\\.[0-9]'
    ) |>
    kable(format='html', escape=FALSE, align='lcccc') |>
    kable_styling('striped') |>
    add_p_value_footnote()
} else if (knitr::is_latex_output()) {
  wrap_table(
    chuck(CH5_TABLE_LIST, 'TAB7'),
    my_label = 'tab:ch5tab7',
    my_caption = chuck(CH5_TABLE_CAPTIONS, 'TAB7')) |>
    str_split('\n') |> unlist() |>
    insert_footnote_manually(.text = "high: serum sodium known for >75\\% of candidates; medium: serum sodium known for >50\\% of candidates; low: otherwise.\\\\ $^{*}$ p < 0.05, $^{**}$ p < 0.01, $^{***}$ p < 0.001") |>
    knitr::asis_output()
}
```

`\FloatBarrier`{=latex}

In discussions with ELIAC and national competent authorities on ReMELD-Na,
concerns were raised about the impact of ReMELD-Na on pediatric,
adolescent, and female transplant candidates. Table \@ref(tab:ch5tab8)
shows the simulated impact of ReMELD-Na on these vulnerable patient groups. The switch
to ReMELD-Na has little impact on outcomes for these patients, suggesting that
the reduction in waiting list deaths is concentrated in males aged 30
years or older. 

The table also shows the impact of ReMELD-Na on candidates with renal dysfunction:
fewer candidates on biweekly dialysis are transplanted under ReMELD-Na, as are
candidates who require a combined liver and kidney transplantation. Such a change
could potentially be welcomed, as there are indications in the literature that 
UNOS-MELD overprioritized candidates with renal dysfunction [@sharmaReweightingModelEndStage2008].

```{r ch5tab8, results='asis'}
d_tab <- read_csv(
  chuck(CH5_TABLE_LIST, 'TAB8')
) |>
  janitor::remove_empty(which='rows') |>
  janitor::remove_empty(which='cols') |>
  mutate(Category = recode(Category, Transplantations = 'Transplanted', `Waitlist deaths` = 'Deceased'))

d_tab <- d_tab[c(1:4, 9, 10, 5:8),]


names(d_tab)[1:2] <- c('group', 'variable')


d_tab <- filter(d_tab, group != 'Males')

names(d_tab)[5] <- c('diff.')
names(d_tab) <- firstlow(names(d_tab))

d_tab$variable <- recode(d_tab$variable, `Waiting list death` = 'WL death') |>
  fct_relabel(firstlow)

d_tab$`per year` <- round(d_tab$`per year`, 1)
d_tab$group <- recode(d_tab$group, `Waiting list death` = 'WL death') |>
  fct_relabel(firstlow)

names(d_tab)[1:2] <- ' '

if (knitr::is_html_output()) {
  
  names(d_tab) <- str_replace(names(d_tab), fixed(' (*)'), '$^a$')

  d_tab |>
    kable(format='html', caption=CH5_TABLE_CAPTIONS[['TAB8']], align='lccccc') |>
    kableExtra::kable_styling('striped') |>
    collapse_rows(1)

} else if (knitr::is_latex_output()) {
  
  d_tab$`UNOS-MELD` <- gsub("(\\[.*?\\])", "\\\\mbox{\\1}", d_tab$`UNOS-MELD`)
  d_tab$`ReMELD-Na` <- gsub("(\\[.*?\\])", "\\\\mbox{\\1}", d_tab$`ReMELD-Na`)
  
  d_tab |>
    kable(format='latex', caption=CH5_TABLE_CAPTIONS[['TAB8']], booktabs=TRUE, escape=FALSE,
          align='cccccc') |>
    kable_styling(
      latex_options = c("scale_down", "hold_position"),
      font_size=9.5
    ) |>
    column_spec(
      1, width='2cm'
    ) |>
    collapse_rows(1) |>
    cat()
}
```

`\FloatBarrier`{=latex}
`\vfill`{=latex}
`\newpage`{=latex}

## Conclusions and discussion {#sec:elasconclusion}

To help align the interests and perspectives of its member countries, 
Eurotransplant requires a tool that can quantify the impact of proposed policy 
changes to its liver allocation system. Discrete-event simulation is an excellent tool for this purpose, and
is already routinely used in other geographic regions to revise organ allocation
policies. This chapter reports on the development of the ELAS simulator, which is the first simulator
tailored to the unique challenges of Eurotransplant as a multi-national
organ exchange organization.

To build trust in the ELAS simulator as a policy evaluation tool, we
have validated the ELAS simulator by comparing simulated outcomes to
observed outcomes between January 1, 2016, and December 31, 2019. We found
that the simulator is able to closely replicate most
patterns in Eurotransplant liver allocation. In our own view, and in ELIAC's, the remaining differences are sufficiently small for the
ELAS simulator to contribute to liver allocation policy evaluation
within Eurotransplant. We have illustrated this with two case studies.
The case study on the Belgian exception point system has been discussed within
BeLIAC, and has led to a recommendation to cap (N)SE scores in Belgium at 28.
The case study on ReMELD-Na has led to a recommendation to switch to allocation
based on ReMELD-Na, which was implemented on March 25, 2025.

Although this demonstrates that the ELAS simulator is useful for policy
evaluation, the software also has limitations. A first limitation is that our 
simulations are driven by Eurotransplant registry data, which does not capture all information relevant
for liver allocation development. For example, in the second case study we have seen that
serum sodium is not available in Eurotransplant registry data for many candidates, which
complicated the assessment of the impact of allocation based on ReMELD-Na. This limitation could be addressed by prospective
data collection of factors relevant to allocation. Secondly, the statistical models 
for graft offer acceptance behavior and post-transplant survival were calibrated 
to historical data. Developments in liver transplantation threaten the external validity of
these models. An example of such a development is machine perfusion,
which is enhancing the outcomes after liver transplantation
[@terraultLiverTransplantation20232023] and which is altering the graft offer
acceptance behavior of transplant centers. This limitation can
potentially be addressed by re-calibrating the statistical models with
contemporary data.

From a policy perspective, several areas remain in which
Eurotransplant's liver allocation system may be improved. These areas
include taking post-transplant outcomes into account when allocating
livers [@Allen2024], broader geographic sharing of livers for candidates
with very high MELD scores
[@massieEarlyChangesLiver2015; @Ravaioli2022], and
rectifying sex disparity in liver waiting list outcomes
[@deFerranteSexDisparityLiver2024]. We anticipate that the ELAS simulator can 
play a role in informing ELIAC of the impact of policy changes
related to these topics.

